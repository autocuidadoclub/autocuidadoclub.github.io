<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AutoCuidado Club - Tu servicio experto de mantenimiento personalizado para veh√≠culos en El Salvador. Sin talleres. Sin filas. Sin excusas.">

  <title>Gesti√≥n de Clientes - AutoCuidado Club</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
</head>

  <style>
   table tr {
  border-bottom: 1px solid #ddd;
}

table td, table th {
  padding: 8px 12px;
  text-align: left;
}

  </style>
  
<body>
  <nav class="navbar">
    <ul>
      <li><a href="calendar.html">Calendar</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="logout.html">Cerrar Sesi√≥n</a></li>
      <li><a href="centro-ayuda.html">Centro de Ayuda</a></li>
      <li><a href="tac.html">T√©rminos y Condiciones</a></li>

    </ul>
  </nav>

  <header>
    <h1>Gesti√≥n de Clientes</h1>
  </header>

  <button onclick="exportAllReferralsToExcel()" style="
    margin-top: 20px;
    background-color: #003366;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
">
    üì• Exportar Todos los Referidos a Excel
</button>


<button onclick="exportAllUsersToExcel()" style="
  margin-top: 20px;
  background-color: #336699;
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
">
üì• Exportar Todos los Usuarios a Excel
</button>


 <h2>Links importantes </h2>
  https://forms.gle/15ECcbdkvrNVdzii6 (para inspecciones de mecanicos)

  <section id="restricted-content" style="display: none;">
    <h2>Panel de Gesti√≥n para el Staff</h2>
    <h3 class="section-title">Buscar Usuarios por Fecha</h3>
<div class="form-control">
  <label for="startDate">Desde:</label>
  <input type="date" id="startDate">
</div>
<div class="form-control">
  <label for="endDate">Hasta:</label>
  <input type="date" id="endDate">
</div>
<button onclick="findUsersByDate()">Buscar Usuarios</button>
<button onclick="exportTableToExcel()">Exportar a Excel</button>

<table id="usersFullTable">
  <thead>
  <tr>
    <th>Usuario</th>
    <th>Email</th>
    <th>Tel√©fono</th>
    <th>Municipio</th>
    <th>Departamento</th>
    <th>Fecha de Registro</th>
    <th>Horario Seleccionado</th>
    <th>Fecha de Pago</th>
    <th>Estado del Pago</th>
    <th>Acciones</th>
  </tr>
</thead>
  <tbody id="paymentTable"></tbody>
</table>


    <div>
      <h3 class="section-title">Verificar Reprogramaciones por Fecha</h3>
      <div class="form-control">
        <label for="rescheduleStartDate">Desde:</label>
        <input type="date" id="rescheduleStartDate" />
      </div>
      <div class="form-control">
        <label for="rescheduleEndDate">Hasta:</label>
        <input type="date" id="rescheduleEndDate" />
      </div>
      <button onclick="findRescheduledUsers()">Buscar Reprogramaciones</button>
      <button onclick="exportTableToExcel()">Exportar a Excel</button>

      <table id="rescheduleFullTable">
      <thead>
  <tr>
    <th>Usuario</th>
    <th>Email</th>
    <th>Tel√©fono</th>
    <th>Horario Seleccionado</th>
    <th>Departamento</th>
    <th>Municipio</th>
    <th>Tipo de Cambio</th>
    <th>Fecha y Hora de Cambio</th>
  </tr>
</thead>
        <tbody id="rescheduleTable"></tbody>
      </table>
    </div>
  </section>

<section id="staffControlSection" style="margin-top: 40px;">
  <h3>üîß Modificar Horario y Ubicaci√≥n del Cliente</h3>
  <input type="email" id="staffSearchEmail" placeholder="Correo del cliente..." />
  <button onclick="loadStaffUser()">Buscar Cliente</button>

  <div id="staffControlForm" style="display:none; margin-top: 20px;">
    <h4>Cliente: <span id="staffClientName">-</span></h4>
    <p>Municipio actual: <span id="currentMunicipality">-</span></p>
    <p>Departamento actual: <span id="currentDepartment">-</span></p>
    <p>Horario actual: <span id="currentSchedule">-</span></p>

    <div id="vehicleInspectionSection" style="margin-top: 20px;">
  <h4>üìÖ Inspecciones por Veh√≠culo</h4>
  <div id="vehicleInspectionList"></div>
</div>

<div id="paymentHistorySection" style="margin-top:20px;">
  <h4>üí≥ Historial de Pagos</h4>
  <table id="paymentHistoryTable" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th>Fecha</th><th>Monto</th><th>M√©todo</th><th>Estado</th>
      </tr>
    </thead>
    <tbody id="paymentHistoryBody">
      <tr><td colspan="4">Sin historial disponible.</td></tr>
    </tbody>
  </table>
</div>

    
    <h4>Deseas confimar pago?<h4>
    <p><button onclick="confirmPayment(selectedStaffUserId)">Confirmar Pago</button><br></p>
      
    <h4>Seleccione Nuevo Horario:</h4>
    <table class="schedule-table">
            <thead>
                <tr>
                    <th>Horario</th>
                    <th>Lunes</th>
                    <th>Mi√©rcoles</th>
                    <th>Viernes</th>
                    <th>S√°bado</th>
                    <th>Domingo</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td></td>
                    <td onclick="selectScheduleBox(this)">9:00 - 11:00</td>
                    <td onclick="selectScheduleBox(this)">10:00 - 12:00</td>
                    <td onclick="selectScheduleBox(this)">13:00 - 15:00</td>
                    <td onclick="selectScheduleBox(this)">8:00 - 10:00</td>
                    <td onclick="selectScheduleBox(this)">9:00 - 11:00</td>
                </tr>
                <tr>
                    <td></td>
                    <td onclick="selectScheduleBox(this)">12:00 - 14:00</td>
                    <td onclick="selectScheduleBox(this)">13:00 - 15:00</td>
                    <td onclick="selectScheduleBox(this)">16:00 - 18:00</td>
                    <td onclick="selectScheduleBox(this)">11:00 - 13:00</td>
                    <td onclick="selectScheduleBox(this)">12:00 - 14:00</td>
                </tr>
                <tr>
                    <td></td>
                    <td onclick="selectScheduleBox(this)">15:00 - 17:00</td>
                    <td onclick="selectScheduleBox(this)">16:00 - 18:00</td>
                    <td onclick="selectScheduleBox(this)">-</td>
                    <td onclick="selectScheduleBox(this)">14:00 - 16:00</td>
                    <td onclick="selectScheduleBox(this)">-</td>
                </tr>
            </tbody>
        </table>

     <h4>Seleccione una nueva ubicaci√≥n</h4>
   <label for="department">Departamento:</label>
    <select id="department" onchange="updateMunicipalities()" required>
        <option value="">Seleccione un departamento</option>
    </select>
    
    <label for="municipality">Municipio:</label>
    <select id="municipality" required>
        <option value="">Seleccione un municipio</option>
    </select>
   
    <br />
    <button onclick="saveStaffClientChanges()">Guardar Cambios</button>
  </div>
</section>

      

 <div id="customAlert" style="
  display: none;
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #4CAF50; /* default green */
  color: white;
  padding: 15px 20px;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 9999;
  font-weight: bold;
">
  ‚úÖ Mensaje de ejemplo.
</div>

     <div style="background-color: #003893; color: white; padding: 20px; border-radius: 12px 12px 0 0;">
  <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap;">
    <img src="/flag-sv.png" alt="Bandera El Salvador" style="height: 60px; margin-right: 20px; border-radius: 6px; box-shadow: 0 0 6px rgba(0,0,0,0.3);">
    <div style="text-align: left; max-width: 300px;">
      <p style="margin: 0; font-size: 18px; font-weight: bold;">
        Esta app es m√°s que tecnolog√≠a.
      </p>
      <p style="margin: 5px 0 0; font-size: 16px;">
        Es una forma distinta de cuidar lo que importa.
      </p>
    </div>
  </div>
  <p style="text-align: center; margin-top: 20px; font-size: 16px;">
    <span style="color: #FFA500; font-weight: bold;">AutoCuidado Club</span> ‚Äî Hecha con visi√≥n. Hecha con orgullo en <strong>El Salvador.</strong>
  </p>
</div>

      

         <div id="emailModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px #000; z-index:1000;">
  <h3>üìß Email para el Cliente</h3>
  <textarea id="emailTemplate" style="width:100%; height:200px;"></textarea>
  <button onclick="copyEmail()">üìã Copiar correo</button>
  <button onclick="closeEmailModal()">‚ùå Cerrar</button>
</div>


      <!-- Loading Spinner for Payment Confirmation -->
<div id="paymentLoadingOverlay" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.8);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  text-align: center;
">
  <img src="/loading.gif" alt="Verificando..." style="width:100px;height:100px;margin-bottom:15px;">
  <p style="font-weight:bold;color:#003366;font-size:18px;">
    ‚è≥ Verificando pago... por favor espera unos segundos
  </p>
</div>


  <script src="env.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: window._env_.FIREBASE_API_KEY,
      authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
      databaseURL: window._env_.FIREBASE_DATABASE_URL,
      projectId: window._env_.FIREBASE_PROJECT_ID,
      storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
      messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
      appId: window._env_.FIREBASE_APP_ID,
      measurementId: window._env_.FIREBASE_MEASUREMENT_ID,
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const serverKey = "YOUR_SERVER_KEY_HERE";

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (userDoc.exists && userDoc.data().role === "staff") {
          document.getElementById("restricted-content").style.display = "block";
        } else {
          alert("No tienes permiso para acceder a staff.html");
          window.location.href = "login.html";
        }
      } else {
        alert("Por favor, inicia sesi√≥n.");
        window.location.href = "login.html";
      }
    });
    
async function findUsersByDate() {
  const startDateInput = document.getElementById("startDate").value;
  const endDateInput = document.getElementById("endDate").value;

  if (!startDateInput || !endDateInput) {
    alert("Por favor, selecciona ambas fechas.");
    return;
  }

  const startDate = new Date(startDateInput);
  const endDate = new Date(endDateInput);
  endDate.setDate(endDate.getDate() + 1); // Incluir el d√≠a completo

  const table = document.getElementById("paymentTable");
  table.innerHTML = "";

  try {
    // Run parallel optimized queries ‚úÖ
    const [registrationSnapshot, municipalitySnapshot, departmentSnapshot] = await Promise.all([
      db.collection("users")
        .where("registrationDate", ">=", firebase.firestore.Timestamp.fromDate(startDate))
        .where("registrationDate", "<", firebase.firestore.Timestamp.fromDate(endDate))
        .get(),

      db.collection("users")
        .where("lastMunicipalityChange", ">=", firebase.firestore.Timestamp.fromDate(startDate))
        .where("lastMunicipalityChange", "<", firebase.firestore.Timestamp.fromDate(endDate))
        .get(),

      db.collection("users")
        .where("lastDepartmentChange", ">=", firebase.firestore.Timestamp.fromDate(startDate))
        .where("lastDepartmentChange", "<", firebase.firestore.Timestamp.fromDate(endDate))
        .get(),
    ]);

    // Merge results and remove duplicates ‚úÖ
    const userMap = new Map();

    const addToMap = (snapshot) => {
      snapshot.forEach(doc => {
        if (!userMap.has(doc.id)) {
          userMap.set(doc.id, doc.data());
        }
      });
    };

    addToMap(registrationSnapshot);
    addToMap(municipalitySnapshot);
    addToMap(departmentSnapshot);

    if (userMap.size === 0) {
      alert("No se encontraron usuarios en el rango de fechas.");
      return;
    }

    userMap.forEach((user, userId) => {
      updatePaymentTable(user, userId);
    });

    console.log(`‚úÖ Usuarios encontrados: ${userMap.size}`);
  } catch (error) {
    console.error("‚ùå Error al buscar usuarios:", error);
    alert("Error al buscar usuarios.");
  }
}


function updatePaymentTable(user, userId) {
  const table = document.getElementById("paymentTable");
  const registrationDate = user.registrationDate?.toDate().toLocaleDateString("es-ES") || "Sin fecha";
  const schedule = user.schedule ? `${user.schedule.day} - ${user.schedule.time}` : "No asignado"; // ‚úÖ Campo correcto ahora
  const paymentDate = user.paymentDate?.toDate().toLocaleDateString("es-ES") || "Sin fecha";
  const municipio = user.municipality || "No registrado";
  const departamento = user.department || "No registrado";

  table.innerHTML += `
    <tr style="border-bottom: 1px solid #ccc;">
      <td>${user.name || "Sin nombre"}</td>
      <td>${user.email}</td>
      <td>${user.phone || "No disponible"}</td>
      <td>${municipio}</td>
      <td>${departamento}</td>
      <td>${registrationDate}</td>
      <td>${schedule}</td>
      <td>${paymentDate}</td>
      <td>${user.paymentStatus || "Pendiente"}</td>
      <td>
        <button onclick="confirmPayment('${userId}')">Confirmar Pago</button><br>
      </td>
    </tr>`;
}

    function formatDate(timestamp) {
  if (!timestamp || !timestamp.toDate) return "";
  const date = timestamp.toDate();
  const day = String(date.getDate()).padStart(2, "0");
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

function formatDateTime(timestamp) {
  if (!timestamp || !timestamp.toDate) return "";
  const date = timestamp.toDate();
  const day = String(date.getDate()).padStart(2, "0");
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, "0");
  const minutes = String(date.getMinutes()).padStart(2, "0");
  return `${day}/${month}/${year} ${hours}:${minutes}`;
}

async function exportAllReferralsToExcel() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            alert("Debes iniciar sesi√≥n para exportar referidos.");
            return;
        }

        const referralsSnapshot = await db.collectionGroup("referrals").get();

        if (referralsSnapshot.empty) {
            alert("No hay referidos para exportar.");
            return;
        }

        const data = [];

        for (const doc of referralsSnapshot.docs) {
            const referral = doc.data();

            // Get parent document (referrer user)
            const pathParts = doc.ref.path.split('/');
            const userId = pathParts[1];

            const userDoc = await db.collection("users").doc(userId).get();
            const userData = userDoc.exists ? userDoc.data() : {};

            data.push({
                "Referrer Nombre": userData.name || "Desconocido",
                "Referrer Email": userData.email || "Desconocido",
                "Referrer Tel√©fono": userData.phone || "Desconocido",
                "Nombre del Referido": referral.name || "",
                "Correo del Referido": referral.email || "",
                "WhatsApp del Referido": referral.phone || "",
                "Estado 1: Info Enviada": referral.timestamp ? "‚úÖ" : "‚è≥",
                "Estado 2: Registrado": referral.registered ? "‚úÖ" : "‚è≥",
                "Estado 3: Pago Completado": referral.paid ? "‚úÖ" : "‚è≥",
                "Fecha de Registro": referral.timestamp?.toDate().toLocaleString("es-ES") || "",
            });
        }

        // Generate Excel
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Todos Referidos");

        const exportFileName = `Todos_Referidos_${new Date().toISOString().slice(0, 10)}.xlsx`;
        XLSX.writeFile(workbook, exportFileName);

        alert("‚úÖ Exportaci√≥n global completada. Revisa tu archivo Excel.");

    } catch (error) {
        console.error("‚ùå Error al exportar referidos globales:", error);
        alert("Error al exportar los referidos. Intenta nuevamente.");
    }
}


async function exportAllUsersToExcel() {
  try {
    const snapshot = await db.collection("users").get();
    const data = [];

    for (const doc of snapshot.docs) {
      const user = doc.data();

      const row = {
        UID: doc.id,
        Nombre: user.name || "",
        Email: user.email || "",
        Tel√©fono: user.phone || "",
        Departamento: user.department || "",
        Municipio: user.municipality || "",
        Plan: user.planType || "",
        EstadoPago: user.paymentStatus || "",
        MesesPagados: user.monthsPaid ?? 0,
        EstadoSuscripci√≥n: user.subscriptionStatus || "",
        FechaRegistro: formatDate(user.registrationDate),
        FechaPago: formatDate(user.paymentDate),
        Pr√≥ximoPago: formatDate(user.nextPaymentDate),
        √öltimoCambioMunicipio: formatDate(user.lastMunicipalityChange),
        √öltimoCambioHorario: formatDate(user.lastReschedule),
        √öltimoCambioPlan: formatDate(user.lastPlanUpgradeDate),
        √öltimoResetLealtad: formatDate(user.lastLoyaltyReset),
        "Premios Redimidos": user.rewardsRedeemed ? "‚úÖ S√≠" : "‚è≥ No",
      };

      // Agregar info del horario seleccionado
      if (user.schedule) {
        row.HorarioActual = `${user.schedule.day} - ${user.schedule.time}`;
      } else {
        row.HorarioActual = "No asignado";
      }

      // Agregar resumen veh√≠culos
      if (user.vehicles && Array.isArray(user.vehicles)) {
        row.Veh√≠culos = user.vehicles.map(v => `${v.plate} (${v.brand} ${v.model})`).join(" | ");
      }

      // Agregar resumen historial de pagos
      if (user.paymentHistory && Array.isArray(user.paymentHistory)) {
        row.HistorialPagos = user.paymentHistory.map(p =>
          `${formatDate(p.date)} - $${p.amount} - ${p.method}`
        ).join(" | ");
      }

      // Agregar info de redenci√≥n (si existe)
      if (user.redeemRequest) {
        row.Redenci√≥n_Nombre = user.redeemRequest.name || "";
        row.Redenci√≥n_Email = user.redeemRequest.email || "";
        row.Redenci√≥n_Tel√©fono = user.redeemRequest.phone || "";
        row.Redenci√≥n_Mes = user.redeemRequest.month || "";
        row.Redenci√≥n_Fecha = formatDateTime(user.redeemRequest.timestamp);
      }

      data.push(row);
    }

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Clientes");

    const fileName = `Clientes_AutoCuidado_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(workbook, fileName);

    alert("‚úÖ Exportaci√≥n completada.");
  } catch (error) {
    console.error("‚ùå Error exportando usuarios:", error);
    alert("Error al exportar usuarios.");
  }
}
    
    function getPaymentHistoryByEmail() {
  const email = document.getElementById("searchEmail").value.trim();
  if (!email) return alert("Escribe el correo del cliente.");

  db.collection("users").where("email", "==", email).get()
    .then((querySnapshot) => {
      if (querySnapshot.empty) {
        alert("No se encontr√≥ ning√∫n cliente con ese correo.");
        return;
      }

      const doc = querySnapshot.docs[0];
      const history = doc.data().paymentHistory || [];
      const body = document.getElementById("staffHistoryBody");
      const table = document.getElementById("staffHistoryTable");
      body.innerHTML = "";

      if (history.length === 0) {
        body.innerHTML = '<tr><td colspan="4">Sin historial registrado.</td></tr>';
      } else {
        history.forEach(entry => {
          const date = entry.date?.toDate().toLocaleDateString("es-ES") || "-";
          body.innerHTML += `
            <tr>
              <td>${date}</td>
              <td>$${entry.amount || "N/A"}</td>
              <td>${entry.method || "-"}</td>
              <td>${entry.status || "-"}</td>
            </tr>`;
        });
      }

      table.style.display = "table";
    })
    .catch((error) => {
      console.error("‚ùå Error buscando historial de pago:", error);
      alert("Error al buscar historial.");
    });
}

    
// ‚úÖ Correct ‚Äì call your Cloud Function instead
async function confirmPayment(userId) {
  const overlay = document.getElementById("paymentLoadingOverlay");
  overlay.style.display = "flex"; // Show loading overlay

  try {
    console.log("üîç Confirming payment for:", userId);

    const response = await fetch(
      "https://us-central1-bookings-autocuidad-club.cloudfunctions.net/confirmPayment",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
      }
    );

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Request failed");

    console.log("‚úÖ Payment confirmed:", data);

    overlay.style.display = "none"; // Hide loader
    alert("‚úÖ Pago confirmado correctamente");

    // Optional: reload after a short delay to reflect new data
    setTimeout(() => location.reload(), 1000);
  } catch (err) {
    console.error("‚ùå Error al confirmar pago:", err);
    overlay.style.display = "none"; // Hide loader
    alert("‚ùå Error al confirmar pago. Intenta nuevamente.");
  }
}


  async function findRescheduledUsers() {
  const startDate = new Date(document.getElementById("rescheduleStartDate").value);
  const endDate = new Date(document.getElementById("rescheduleEndDate").value);
  endDate.setDate(endDate.getDate() + 1);

  const rescheduleTable = document.getElementById("rescheduleTable");
  rescheduleTable.innerHTML = "";

  try {
    // Run parallel filtered queries ‚úÖ
    const [reschedules, municipalityChanges, departmentChanges] = await Promise.all([
      db.collection("users")
        .where("lastReschedule", ">=", firebase.firestore.Timestamp.fromDate(startDate))
        .where("lastReschedule", "<", firebase.firestore.Timestamp.fromDate(endDate))
        .get(),

      db.collection("users")
        .where("lastMunicipalityChange", ">=", firebase.firestore.Timestamp.fromDate(startDate))
        .where("lastMunicipalityChange", "<", firebase.firestore.Timestamp.fromDate(endDate))
        .get(),

      db.collection("users")
        .where("lastDepartmentChange", ">=", firebase.firestore.Timestamp.fromDate(startDate))
        .where("lastDepartmentChange", "<", firebase.firestore.Timestamp.fromDate(endDate))
        .get(),
    ]);

    // Merge documents and avoid duplicates ‚úÖ
    const userMap = new Map();

    const addToMap = (snapshot, changeType) => {
      snapshot.forEach(doc => {
        const user = doc.data();
        const existing = userMap.get(doc.id) || { data: user, changes: new Set(), dates: [] };

        existing.changes.add(changeType);

        if (changeType === "Horario" && user.lastReschedule) {
          existing.dates.push(`Horario: ${user.lastReschedule.toDate().toLocaleDateString("es-ES")} ${user.lastReschedule.toDate().toLocaleTimeString("es-ES")}`);
        }
        if (changeType === "Municipio" && user.lastMunicipalityChange) {
          existing.dates.push(`Municipio: ${user.lastMunicipalityChange.toDate().toLocaleDateString("es-ES")} ${user.lastMunicipalityChange.toDate().toLocaleTimeString("es-ES")}`);
        }
        if (changeType === "Departamento" && user.lastDepartmentChange) {
          existing.dates.push(`Departamento: ${user.lastDepartmentChange.toDate().toLocaleDateString("es-ES")} ${user.lastDepartmentChange.toDate().toLocaleTimeString("es-ES")}`);
        }

        userMap.set(doc.id, existing);
      });
    };

    addToMap(reschedules, "Horario");
    addToMap(municipalityChanges, "Municipio");
    addToMap(departmentChanges, "Departamento");

    if (userMap.size === 0) {
      alert("No se encontraron usuarios con cambios en el rango de fechas.");
      return;
    }

    // Display merged results ‚úÖ
    userMap.forEach(({ data: user, changes, dates }) => {
      const schedule = user.schedule ? `${user.schedule.day}, ${user.schedule.time}` : "No asignado";
      const department = user.department || "No registrado";
      const municipality = user.municipality || "No registrado";
      const changeTypes = Array.from(changes).map(type => {
        if (type === "Horario") return "Reprogramaci√≥n de Horario";
        if (type === "Municipio") return "Cambio de Municipio";
        if (type === "Departamento") return "Cambio de Departamento";
      }).join(" / ");

      rescheduleTable.innerHTML += `
        <tr>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.phone || "No disponible"}</td>
          <td>${schedule}</td>
          <td>${department}</td> 
          <td>${municipality}</td>
          <td>${changeTypes}</td>
          <td>${dates.join("<br>")}</td>
        </tr>`;
    });

    console.log(`‚úÖ Optimized query completed. Total users found: ${userMap.size}`);
  } catch (error) {
    console.error("‚ùå Error fetching optimized changes:", error);
    alert("Error al buscar cambios.");
  }
}


function exportTableToExcel() {
  const table = document.getElementById("rescheduleFullTable");

  if (!table || table.rows.length <= 1) {
    alert("No hay datos para exportar.");
    return;
  }

  const workbook = XLSX.utils.table_to_book(table, { sheet: "Reprogramaciones" });
  XLSX.writeFile(workbook, "reprogramaciones.xlsx");
}


   function exportUsersToExcel() {
  const table = document.getElementById("usersFullTable");

  if (!table || table.rows.length <= 1) {
    alert("No hay datos para exportar.");
    return;
  }

  const workbook = XLSX.utils.table_to_book(table, { sheet: "Usuarios" });
  XLSX.writeFile(workbook, "usuarios.xlsx");
}


   let staffSelectedUserId = null;

let selectedStaffUserId = null;
let staffSelectedDay = "";
let staffSelectedTime = "";

// Update your existing selectScheduleBox function to store day/time in these variables:
function selectScheduleBox(cell) {
    const cells = document.querySelectorAll(".schedule-table tbody td");

    // Get the clicked cell's text
    const timeBlock = cell.innerText.trim();

    // Validate the clicked cell
    if (timeBlock === "-" || timeBlock === "") {
        alert("Por favor, seleccione un horario v√°lido.");
        return; // Do not allow selection of invalid cells
    }

    // Remove selection from all other cells
    cells.forEach((c) => c.classList.remove("selected-box"));

    // Highlight the selected cell
    cell.classList.add("selected-box");

    // Get the corresponding day from the column header
    const dayIndex = cell.cellIndex; // Get the column index of the clicked cell
    const dayHeader = document.querySelector(`.schedule-table thead th:nth-child(${dayIndex + 1})`);
    const day = dayHeader ? dayHeader.innerText.trim() : "D√≠a desconocido";
   
    console.log(`Horario seleccionado: ${day} - ${timeBlock}`);
}

        const locations = {
            "Ahuachap√°n": ["Ahuachap√°n", "Apaneca", "Atiquizaya", "Concepci√≥n de Ataco", "El Refugio", "Guaymango", "Jujutla", "San Francisco Men√©ndez", "San Lorenzo", "San Pedro Puxtla", "Tacuba", "Tur√≠n"],
            "Santa Ana": ["Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "Masahuat", "Metap√°n", "San Antonio Pajonal", "San Sebasti√°n Salitrillo", "Santa Ana", "Santa Rosa Guachipil√≠n", "Texistepeque"],
            "Sonsonate": ["Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "Juay√∫a", "Nahuizalco", "Nahulingo", "Salcoatit√°n", "San Antonio del Monte", "San Juli√°n", "Santa Catarina Masahuat", "Santa Isabel Ishuat√°n", "Santo Domingo de Guzm√°n", "Sonsonate", "Sonzacate"],
            "Chalatenango": ["Agua Caliente", "Arcatao", "Azacualpa", "Chalatenango", "Cital√°", "Comalapa", "Concepci√≥n Quezaltepeque", "Dulce Nombre de Mar√≠a", "El Carrizal", "El Para√≠so", "La Laguna", "La Palma", "Las Flores", "Las Vueltas", "Nueva Concepci√≥n", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco Moraz√°n", "San Ignacio", "San Isidro Labrador", "San Jos√© Cancasque", "San Jos√© Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],
            "Cuscatl√°n": ["Candelaria", "Cojutepeque", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de Concepci√≥n", "San Bartolom√© Perulap√≠a", "San Crist√≥bal", "San Jos√© Guayabal", "San Pedro Perulap√°n", "San Rafael Cedros", "San Ram√≥n", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo"],
            "San Salvador": ["Aguilares", "Apopa", "Ayutuxtepeque", "Ciudad Delgado", "Cuscatancingo", "El Paisnal", "Guazapa", "Ilopango", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San Mart√≠n", "San Salvador", "Santiago Texacuangos", "Santo Tom√°s", "Soyapango", "Tonacatepeque"],
            "La Libertad": ["Antiguo Cuscatl√°n", "Chiltiup√°n", "Ciudad Arce", "Col√≥n", "Comasagua", "Huiz√∫car", "Jayaque", "Jicalapa", "La Libertad", "Nuevo Cuscatl√°n", "San Juan Opico", "Quezaltepeque", "Sacacoyo", "San Jos√© Villanueva", "San Mat√≠as", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],
            "San Vicente": ["Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San Sebasti√°n", "San Vicente", "Santa Clara", "Santo Domingo", "Tecoluca", "Tepetit√°n", "Verapaz"],
            "Caba√±as": ["Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Sensuntepeque", "Tejutepeque", "Victoria"],
            "Usulut√°n": ["Alegr√≠a", "Berl√≠n", "California", "Concepci√≥n Batres", "El Triunfo", "Ereguayqu√≠n", "Estanzuelas", "Jiquilisco", "Jucuapa", "Jucuar√°n", "Mercedes Uma√±a", "Nueva Granada", "Ozatl√°n", "Puerto El Triunfo", "San Agust√≠n", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa Mar√≠a", "Santiago de Mar√≠a", "Tecap√°n", "Usulut√°n"],
            "San Miguel": ["Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "Comacar√°n", "El Tr√°nsito", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo Ed√©n de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Miguel", "San Rafael Oriente", "Sesori", "Uluazapa"],
            "Moraz√°n": ["Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de Concepci√≥n", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Lolotiquillo", "Meanguera", "Osicala", "Perqu√≠n", "San Carlos", "San Fernando", "San Francisco Gotera", "San Isidro", "San Sim√≥n", "Sensembra", "Sociedad", "Torola", "Yamabal", "Yoloaiqu√≠n"],
            "La Uni√≥n": ["Anamor√≥s", "Bol√≠var", "Concepci√≥n de Oriente", "Conchagua", "El Carmen", "El Sauce", "Intipuc√°", "La Uni√≥n", "Lislique", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "Polor√≥s", "San Alejo", "San Jos√©", "Santa Rosa de Lima", "Yayantique", "Yucuaiqu√≠n"]
        };
        const departmentSelect = document.getElementById("department");
        const municipalitySelect = document.getElementById("municipality");

        // Populate the departments dropdown
        function populateDepartments() {
            for (const department in locations) {
                const option = document.createElement("option");
                option.value = department;
                option.textContent = department;
                departmentSelect.appendChild(option);
            }
        }

        // Update municipalities based on selected department
        function updateMunicipalities() {
            const selectedDepartment = departmentSelect.value;
            municipalitySelect.innerHTML = '<option value="">Seleccione un municipio</option>'; // Reset municipalities

            if (locations[selectedDepartment]) {
                locations[selectedDepartment].forEach(municipality => {
                    const option = document.createElement("option");
                    option.value = municipality;
                    option.textContent = municipality;
                    municipalitySelect.appendChild(option);
                });
            }
        }

        // Initialize departments on page load
        document.addEventListener("DOMContentLoaded", populateDepartments);

    function loadStaffUser() {
  const email = document.getElementById("staffSearchEmail").value.trim();

  if (!email) {
    alert("Por favor ingrese un correo de cliente.");
    return;
  }

  db.collection("users").where("email", "==", email).get()
    .then(querySnapshot => {
      if (querySnapshot.empty) {
        alert("Cliente no encontrado.");
        return;
      }

      const doc = querySnapshot.docs[0];
      const user = doc.data();
      selectedStaffUserId = doc.id;

      document.getElementById("staffClientName").innerText = user.name || "-";
      document.getElementById("currentMunicipality").innerText = user.municipality || "-";
      document.getElementById("currentDepartment").innerText = user.department || "-";
      document.getElementById("currentSchedule").innerText = user.schedule ? `${user.schedule.day} - ${user.schedule.time}` : "-";
      document.getElementById("staffControlForm").style.display = "block";
      renderVehicleInspections(user.vehicles || [], selectedStaffUserId);

     
      if (user.staffLastChangeNote) {
  const note = document.createElement("p");
  note.innerText = "üìù " + user.staffLastChangeNote;
  document.getElementById("staffControlForm").prepend(note);
}

      
if (user.paymentHistory && Array.isArray(user.paymentHistory)) {
  const tbody = document.getElementById("paymentHistoryBody");
  tbody.innerHTML = "";
  user.paymentHistory.forEach(entry => {
    const date = entry.date?.toDate?.() ? entry.date.toDate().toLocaleDateString("es-ES") : "-";
    tbody.innerHTML += `
      <tr>
        <td>${date}</td>
        <td>$${entry.amount || "-"}</td>
        <td>${entry.method || "-"}</td>
        <td>${entry.status || "-"}</td>
      </tr>
    `;
  });
}

    })
    .catch(error => {
      console.error("‚ùå Error al buscar cliente:", error);
      alert("Error al buscar cliente.");
    });
}

  function saveStaffClientChanges() {
  if (!selectedStaffUserId) {
    showCustomAlert("‚ùå Por favor busca primero un cliente.", "error");
    return;
  }

  // Leer datos actuales visibles en la interfaz
  const currentDepartment = document.getElementById("currentDepartment").innerText.trim();
  const currentMunicipality = document.getElementById("currentMunicipality").innerText.trim();
  const currentSchedule = document.getElementById("currentSchedule").innerText.trim();

  const newDepartment = document.getElementById("department").value.trim();
  const newMunicipality = document.getElementById("municipality").value.trim();

  const selectedCell = document.querySelector(".schedule-table td.selected-box");
  let isScheduleChanged = false;
  let selectedScheduleText = "";

  if (selectedCell) {
    const dayIndex = selectedCell.cellIndex;
    const timeBlock = selectedCell.innerText.trim();
    const dayHeader = document.querySelector(`.schedule-table thead th:nth-child(${dayIndex + 1})`);
    const day = dayHeader ? dayHeader.innerText.trim() : "";

    selectedScheduleText = `${day} - ${timeBlock}`;

    if (selectedScheduleText !== currentSchedule && day && timeBlock && timeBlock !== "-") {
      isScheduleChanged = true;
    }
  }

  const isDepartmentChanged = newDepartment && newDepartment !== currentDepartment;
  const isMunicipalityChanged = newMunicipality && newMunicipality !== currentMunicipality;

  // üß© Validaci√≥n especial: Si cambia departamento, debe seleccionar municipio
  if (isDepartmentChanged && !newMunicipality) {
    showCustomAlert("‚ùå Si cambias el departamento, debes seleccionar tambi√©n el municipio.", "error");
    return;
  }

  // üß© Validaci√≥n final: si no hay cambios
  if (!isDepartmentChanged && !isMunicipalityChanged && !isScheduleChanged) {
    showCustomAlert("‚ùå No se detectaron cambios para guardar.", "error");
    return;
  }

  // Preparar actualizaciones
  const updates = {};
  const nowTimestamp = firebase.firestore.Timestamp.now();
  const now = new Date();
  const formattedDate = now.toLocaleDateString("es-ES");
  const formattedTime = now.toLocaleTimeString("es-ES");
  const changeNote = `Cambio hecho por staff el ${formattedDate} a las ${formattedTime}`;
  updates.staffLastChangeNote = changeNote;

  if (isDepartmentChanged) {
    updates.department = newDepartment;
    updates.lastDepartmentChange = nowTimestamp;
  }

  if (isMunicipalityChanged) {
    updates.municipality = newMunicipality;
    updates.lastMunicipalityChange = nowTimestamp;
  }

  if (isScheduleChanged) {
  const [selectedDay, selectedTime] = selectedScheduleText.split(" - ");
  updates.schedule = {
    day: selectedDay.trim(),
    time: selectedTime.trim()
  };
  updates.lastReschedule = nowTimestamp;
}


  // Guardar cambios en Firestore
  // ‚úÖ New secure Cloud Function path
const functions = firebase.app().functions("us-central1");

async function saveStaffClientChanges() {
  if (!selectedStaffUserId) {
    showCustomAlert("‚ùå Por favor busca primero un cliente.", "error");
    return;
  }

  const currentDepartment = document.getElementById("currentDepartment").innerText.trim();
  const currentMunicipality = document.getElementById("currentMunicipality").innerText.trim();
  const currentSchedule = document.getElementById("currentSchedule").innerText.trim();

  const newDepartment = document.getElementById("department").value.trim();
  const newMunicipality = document.getElementById("municipality").value.trim();

  const selectedCell = document.querySelector(".schedule-table td.selected-box");
  let isScheduleChanged = false;
  let selectedScheduleText = "";

  if (selectedCell) {
    const dayIndex = selectedCell.cellIndex;
    const timeBlock = selectedCell.innerText.trim();
    const dayHeader = document.querySelector(`.schedule-table thead th:nth-child(${dayIndex + 1})`);
    const day = dayHeader ? dayHeader.innerText.trim() : "";
    selectedScheduleText = `${day} - ${timeBlock}`;
    if (selectedScheduleText !== currentSchedule && timeBlock !== "-") {
      isScheduleChanged = true;
    }
  }

  const isDepartmentChanged = newDepartment && newDepartment !== currentDepartment;
  const isMunicipalityChanged = newMunicipality && newMunicipality !== currentMunicipality;

  if (!isDepartmentChanged && !isMunicipalityChanged && !isScheduleChanged) {
    showCustomAlert("‚ùå No se detectaron cambios para guardar.", "error");
    return;
  }

  // Build updates
  const updates = {};
  const nowTimestamp = firebase.firestore.Timestamp.now();
  const now = new Date();
  const formattedDate = now.toLocaleDateString("es-ES");
  const formattedTime = now.toLocaleTimeString("es-ES");
  updates.staffLastChangeNote = `Cambio hecho por staff el ${formattedDate} a las ${formattedTime}`;

  if (isDepartmentChanged) {
    updates.department = newDepartment;
    updates.lastDepartmentChange = nowTimestamp;
  }
  if (isMunicipalityChanged) {
    updates.municipality = newMunicipality;
    updates.lastMunicipalityChange = nowTimestamp;
  }
  if (isScheduleChanged) {
    const [selectedDay, selectedTime] = selectedScheduleText.split(" - ");
    updates.schedule = { day: selectedDay.trim(), time: selectedTime.trim() };
    updates.lastReschedule = nowTimestamp;
  }

  // üîÑ Show loading.gif while saving
  const overlay = document.createElement("div");
  overlay.style.cssText = `
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(255,255,255,0.7);display:flex;
    align-items:center;justify-content:center;z-index:9999;
    flex-direction:column;text-align:center;
  `;
  overlay.innerHTML = `
    <img src="/loading.gif" style="width:120px;margin-bottom:10px;">
    <p style="font-weight:bold;color:#003366;">Guardando cambios...</p>
  `;
  document.body.appendChild(overlay);

  try {
    const callable = functions.httpsCallable("staffUpdateUser");
    await callable({ userId: selectedStaffUserId, updates });
    showCustomAlert("‚úÖ Cambios guardados correctamente.", "success");
    setTimeout(() => location.reload(), 1000);
  } catch (err) {
    console.error("‚ùå Error Cloud Function:", err);
    showCustomAlert("‚ùå Error al guardar cambios.", "error");
  } finally {
    overlay.remove();
  }
}


function showCustomAlert(message, type = "success") {
  const alertBox = document.getElementById("customAlert");
  alertBox.textContent = message;

  // Set color based on type
  if (type === "success") {
    alertBox.style.backgroundColor = "#4CAF50"; // green
  } else if (type === "error") {
    alertBox.style.backgroundColor = "#f44336"; // red
  }

  alertBox.style.display = "block";

  setTimeout(() => {
    alertBox.style.display = "none";
  }, 3000);
}

function renderVehicleInspections(vehicles, userId) {
  const container = document.getElementById("vehicleInspectionList");
  container.innerHTML = "";

  if (!vehicles || vehicles.length === 0) {
    container.innerHTML = "<p>üöò No hay veh√≠culos registrados.</p>";
    return;
  }

  vehicles.forEach((vehicle, index) => {
    const vehicleBox = document.createElement("div");
    vehicleBox.style.border = "1px solid #ccc";
    vehicleBox.style.padding = "10px";
    vehicleBox.style.marginBottom = "15px";
    vehicleBox.innerHTML = `
      <strong>Veh√≠culo ${index + 1}:</strong> ${vehicle.brand} ${vehicle.model} (${vehicle.plate})<br>
      <label>üìÖ Nueva Fecha de Inspecci√≥n:</label>
      <input type="date" id="newInspectionDate${index}" />
      <input type="text" id="inspectionNote${index}" placeholder="Nota (opcional)" />
      <button onclick="saveInspectionDate('${userId}', ${index})">Agregar</button>
      <div><strong>Historial:</strong><br>${
        vehicle.inspectionDates && vehicle.inspectionDates.length > 0
          ? vehicle.inspectionDates.map(entry => `‚úîÔ∏è ${entry.date} (${entry.note || "Sin nota"})`).join("<br>")
          : "Sin inspecciones registradas."
      }</div>
    `;
    container.appendChild(vehicleBox);
  });
}

function saveInspectionDate(userId, vehicleIndex) {
  const dateInput = document.getElementById(`newInspectionDate${vehicleIndex}`).value;
  const noteInput = document.getElementById(`inspectionNote${vehicleIndex}`).value;

  if (!dateInput) {
    alert("Por favor selecciona una fecha.");
    return;
  }

  const userRef = db.collection("users").doc(userId);

  userRef.get().then(doc => {
    if (!doc.exists) return alert("Usuario no encontrado.");

    const data = doc.data();
    const vehicles = data.vehicles || [];

    if (!vehicles[vehicleIndex]) return alert("Veh√≠culo no v√°lido.");

    if (!vehicles[vehicleIndex].inspectionDates) {
      vehicles[vehicleIndex].inspectionDates = [];
    }

    vehicles[vehicleIndex].inspectionDates.push({
      date: dateInput,
      note: noteInput || ""
    });

    userRef.update({ vehicles }).then(() => {
      alert("‚úÖ Inspecci√≥n agregada.");
      loadStaffUser(); // Refresh
    }).catch(err => {
      console.error("‚ùå Error al guardar inspecci√≥n:", err);
      alert("Error al guardar inspecci√≥n.");
    });
  });
}

  function showEmailTemplate(userData) {
  const planData = {
    basic3m:       { label: "B√°sico 3 meses",      price: 34.99, months: 3, type: "Mensual" },
    plus3m:        { label: "Plus 3 meses",        price: 68.99, months: 3, type: "Mensual" },
    basic6m:       { label: "B√°sico 6 meses",      price: 32.50, months: 6, type: "Mensual" },
    plus6m:        { label: "Plus 6 meses",        price: 65.00, months: 6, type: "Mensual" },
    basic12m:      { label: "B√°sico 12 meses",     price: 29.99, months: 12, type: "Mensual" },
    plus12m:       { label: "Plus 12 meses",       price: 59.99, months: 12, type: "Mensual" },
    basic3mfull:   { label: "B√°sico 3 meses",      price: 99.72, months: 3, type: "Contado" },
    plus3mfull:    { label: "Plus 3 meses",        price: 196.62, months: 3, type: "Contado" },
    basic6mfull:   { label: "B√°sico 6 meses",      price: 183.30, months: 6, type: "Contado" },
    plus6mfull:    { label: "Plus 6 meses",        price: 366.60, months: 6, type: "Contado" },
    basic12mfull:  { label: "B√°sico 12 meses",     price: 334.69, months: 12, type: "Contado" },
    plus12mfull:   { label: "Plus 12 meses",       price: 669.49, months: 12, type: "Contado" }
  };

  const plan = planData[userData.planType] || {};
  const amount = plan.price?.toFixed(2) || "0.00";
  const typeText = plan.type || "Desconocido";
  const startMonth = getNextMonthName();

  const msg = `
Hola ${userData.name},

‚úÖ Te confirmamos que hemos recibido tu pago exitosamente en AutoCuidado Club.

üìÖ A partir del mes de ${startMonth}, comenzar√°n tus inspecciones mensuales. Recibir√°s recordatorios con tiempo para coordinar las visitas.

üõ†Ô∏è Plan seleccionado: ${plan.label}
üí≥ Tipo de pago: ${typeText}
üí∞ Monto pagado: $${amount}
üìç Municipio: ${userData.municipality}
üìû Tel√©fono: ${userData.phone}

Gracias por confiar en nosotros. ¬°Nos vemos pronto!

‚Äî
AutoCuidado Club
https://autocuidadoclub.com
`.trim();

  const textarea = document.getElementById("emailTemplate");
  textarea.value = msg;
  document.getElementById("emailModal").style.display = "block";

  // ‚úÖ Auto-copy
  textarea.select();
  document.execCommand("copy");
  alert("üìã Copiado al portapapeles autom√°ticamente.");
}

function closeEmailModal() {
  document.getElementById("emailModal").style.display = "none";
}

function getNextMonthName() {
  const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  return months[(new Date().getMonth() + 1) % 12];
}

    function copyEmail() {
  const textarea = document.getElementById("emailTemplate");
  textarea.select();
  document.execCommand("copy");
  alert("üìã Correo copiado al portapapeles");
}

    
  </script>


      
</body>
</html>
