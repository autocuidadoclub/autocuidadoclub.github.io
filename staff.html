<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - AutoCuidado Club</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="suscripciones.html">Suscripciones</a></li>
            <li><a href="logout.html" onclick="logout()">Cerrar Sesión</a></li>
        </ul>
    </nav>

    <header>
        <h1>Gestión de Clientes</h1>
    </header>

    <!-- Staff Section -->
    <section id="restricted-content" style="display: none;">
        <h2>Panel de Gestión para el Staff</h2>
        <p>Bienvenido, este panel es solo para personal autorizado.</p>

        <!-- Search Section -->
        <form id="searchForm">
            <label for="searchBy">Buscar Por:</label>
            <select id="searchBy" required>
                <option value="email">Email</option>
                <option value="name">Nombre</option>
                <option value="phone">Teléfono</option>
                <option value="licensePlate">Placa del Vehículo</option>
            </select>
            <input type="text" id="searchValue" placeholder="Ingrese el valor de búsqueda" required>
            <button type="submit">Buscar</button>
        </form>

        <!-- Customer Details Section -->
       <section id="user-details" style="display: none;">
    <h2>Detalles del Cliente</h2>
    <!-- General Details Section -->
    <form id="updateGeneralForm">
        <label>UID:</label>
        <input type="text" id="uid" disabled><br>

        <label>Email:</label>
        <input type="email" id="email" disabled><br>

        <label>Departamento:</label>
        <input type="text" id="department"><br>

        <label>Municipio:</label>
        <input type="text" id="municipality"><br>

        <label>Teléfono:</label>
        <input type="text" id="phone"><br>

        <label>Tipo de Plan:</label>
        <select id="planType">
            <option value="basic12m">Básico 12 meses</option>
            <option value="basic6m">Básico 6 meses</option>
            <option value="plus12m">Plus 12 meses</option>
            <option value="plus6m">Plus 6 meses</option>
        </select><br>

        <label>Fecha de Pago Actual:</label>
        <input type="date" id="paymentDate"><br>

        <button type="button" onclick="updateGeneralDetails()">Actualizar Datos Generales</button>
    </form>

    <!-- Vehicle Details Section -->
    <h4>Vehículo 1</h4>
<label>Placa:</label><input type="text" id="vehiclePlate1"><br>
<label>Marca:</label><input type="text" id="vehicleBrand1"><br>
<label>Modelo:</label><input type="text" id="vehicleModel1"><br>
<label>Año:</label><input type="text" id="vehicleYear1"><br>

<h3>Detalles del Vehículo</h3>
<div id="vehicleContainer"></div>
<button type="button" onclick="updateVehicleDetails()">Actualizar Datos de los Vehículos</button>


<button type="button" onclick="updateVehicleDetails()">Actualizar Datos de los Vehículos</button>
          </form>
</section>


    <script>
        // Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyBsYS6pHWaTgXzdml-H_y3lQewWgOUezPM",
            authDomain: "auto-cuidadoclub.firebaseapp.com",
            projectId: "auto-cuidadoclub",
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Authorization Check
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection("users").doc(user.email).get().then((doc) => {
                    if (doc.exists && doc.data().role === "staff") {
                        document.getElementById("restricted-content").style.display = "block";
                    } else {
                        alert("Acceso denegado.");
                        window.location.href = "login.html";
                    }
                });
            } else {
                window.location.href = "login.html";
            }
        });

        // Search Functionality
        document.getElementById("searchForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const searchBy = document.getElementById("searchBy").value;
            const searchValue = document.getElementById("searchValue").value.trim();
            let query;

            if (searchBy === "email") query = db.collection("users").where("email", "==", searchValue);
            if (searchBy === "licensePlate") query = db.collection("users").where("vehicles", "array-contains", { plate: searchValue });
            if (searchBy === "phone") query = db.collection("users").where("phone", "==", searchValue);

            query.get().then(snapshot => {
                snapshot.forEach(doc => displayDetails(doc.data()));
            }).catch(err => alert("Error: " + err));
        });

        // Display User Details
function displayDetails(user) {
    document.getElementById("uid").value = user.uid || "";
    document.getElementById("email").value = user.email || "";
    document.getElementById("department").value = user.department || "";
    document.getElementById("municipality").value = user.municipality || "";
    document.getElementById("phone").value = user.phone || "";
    document.getElementById("planType").value = user.planType || "";
    document.getElementById("registrationDate").value = user.registrationDate?.toDate().toLocaleString() || "";
    document.getElementById("lastReschedule").value = user.lastReschedule?.toDate().toLocaleString() || "";
    document.getElementById("paymentDate").value = user.paymentDate?.toDate().toISOString().split("T")[0] || "";
    document.getElementById("nextPaymentDate").value = user.nextPaymentDate?.toDate().toLocaleString() || "";

    // Dynamic Vehicle Section
    const vehicles = user.vehicles || [];
    const vehicleContainer = document.getElementById("vehicleContainer");
    vehicleContainer.innerHTML = ""; // Clear previous vehicle data

     vehicles.forEach((vehicle, index) => {
        vehicleContainer.innerHTML += `
            <h4>Vehículo ${index + 1}</h4>
            <label>Placa:</label>
            <input type="text" id="vehiclePlate${index}" value="${vehicle.plate || ''}"><br>
            <label>Marca:</label>
            <input type="text" id="vehicleBrand${index}" value="${vehicle.brand || ''}"><br>
            <label>Modelo:</label>
            <input type="text" id="vehicleModel${index}" value="${vehicle.model || ''}"><br>
            <label>Año:</label>
            <input type="text" id="vehicleYear${index}" value="${vehicle.year || ''}"><br>
        `;
    });

    // Make sure the section is visible
    document.getElementById("user-details").style.display = "block";
}


        // Update User Data
       function updateGeneralDetails() {
    const email = document.getElementById("email").value;

    const updatedData = {
        department: document.getElementById("department").value,
        municipality: document.getElementById("municipality").value,
        phone: document.getElementById("phone").value,
        planType: document.getElementById("planType").value,
        paymentDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById("paymentDate").value)),
    };

    db.collection("users").doc(email).update(updatedData)
        .then(() => alert("Datos generales actualizados correctamente."))
        .catch(err => console.error("Error al actualizar los datos generales:", err));
}

function updateVehicleDetails() {
    const email = document.getElementById("email").value.trim();
    if (!email) {
        alert("El email del usuario no está disponible.");
        return;
    }

    // Collect vehicle data dynamically
    const vehicleContainer = document.getElementById("vehicleContainer");
    const vehicleInputs = vehicleContainer.querySelectorAll("input");
    const updatedVehicles = [];

    for (let i = 0; i < vehicleInputs.length; i += 4) {
        const plate = vehicleInputs[i].value.trim();
        const brand = vehicleInputs[i + 1].value.trim();
        const model = vehicleInputs[i + 2].value.trim();
        const year = vehicleInputs[i + 3].value.trim();

        if (plate && brand && model && year) {
            updatedVehicles.push({ plate, brand, model, year });
        }
    }

    if (updatedVehicles.length === 0) {
        alert("Por favor, completa al menos un vehículo.");
        return;
    }

    // Update vehicles in Firestore
    db.collection("users").doc(email).update({ vehicles: updatedVehicles })
        .then(() => {
            alert("Detalles de los vehículos actualizados correctamente.");
            searchCustomer("email", email); // Refresh data
        })
        .catch(err => console.error("Error al actualizar los vehículos:", err));
}


        
        function logout() {
            auth.signOut().then(() => window.location.href = "login.html");
        }
    </script>
</body>
</html>
