<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - AutoCuidado Club</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="suscripciones.html">Suscripciones</a></li>
            <li><a href="logout.html" onclick="logout()">Cerrar Sesión</a></li>
        </ul>
    </nav>

    <header>
        <h1>Gestión de Clientes</h1>
    </header>

    <!-- Staff Section -->
    <section id="restricted-content" style="display: none;">
        <h2>Panel de Gestión para el Staff</h2>
        <p>Bienvenido, este panel es solo para personal autorizado.</p>

        <!-- Search Section -->
        <form id="searchForm">
            <label for="searchBy">Buscar Por:</label>
            <select id="searchBy" required>
                <option value="email">Email</option>
                <option value="name">Nombre</option>
                <option value="phone">Teléfono</option>
                <option value="licensePlate">Placa del Vehículo</option>
            </select>
            <input type="text" id="searchValue" placeholder="Ingrese el valor de búsqueda" required>
            <button type="submit">Buscar</button>
        </form>

        <!-- Customer Details Section -->
        <section id="user-details" style="display: none;">
            <h2>Detalles del Cliente</h2>
            <form id="updateForm">
                <label>UID:</label>
                <input type="text" id="uid" disabled><br>

                <label>Email:</label>
                <input type="email" id="email" disabled><br>

                <label>Departamento:</label>
                <input type="text" id="department"><br>

                <label>Municipio:</label>
                <input type="text" id="municipality"><br>

                <label>Teléfono:</label>
                <input type="text" id="phone"><br>

                <label>Tipo de Plan:</label>
                <select id="planType">
                    <option value="basic12m">Básico 12 meses</option>
                    <option value="basic6m">Básico 6 meses</option>
                    <option value="plus12m">Plus 12 meses</option>
                    <option value="plus6m">Plus 6 meses</option>
                </select><br>

                <label>Fecha de Registro:</label>
                <input type="text" id="registrationDate" disabled><br>

                <label>Último Reagendado:</label>
                <input type="text" id="lastReschedule" disabled><br>

                <label>Fecha de Pago Actual:</label>
                <input type="date" id="paymentDate"><br>

                <label>Próxima Fecha de Pago:</label>
                <input type="text" id="nextPaymentDate" disabled><br>

                <!-- Vehicle Details -->
                <h3>Detalles del Vehículo</h3>
                <label>Placa:</label>
                <input type="text" id="vehiclePlate"><br>

                <label>Marca:</label>
                <input type="text" id="vehicleBrand"><br>

                <label>Modelo:</label>
                <input type="text" id="vehicleModel"><br>

                <label>Año:</label>
                <input type="text" id="vehicleYear"><br>

                <button type="button" onclick="updateUserData()">Actualizar Datos</button>
            </form>
        </section>
    </section>

    <script>
        // Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyBsYS6pHWaTgXzdml-H_y3lQewWgOUezPM",
            authDomain: "auto-cuidadoclub.firebaseapp.com",
            projectId: "auto-cuidadoclub",
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Authorization Check
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection("users").doc(user.email).get().then((doc) => {
                    if (doc.exists && doc.data().role === "staff") {
                        document.getElementById("restricted-content").style.display = "block";
                    } else {
                        alert("Acceso denegado.");
                        window.location.href = "login.html";
                    }
                });
            } else {
                window.location.href = "login.html";
            }
        });

        // Search Functionality
        document.getElementById("searchForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const searchBy = document.getElementById("searchBy").value;
            const searchValue = document.getElementById("searchValue").value.trim();
            let query;

            if (searchBy === "email") query = db.collection("users").where("email", "==", searchValue);
            if (searchBy === "licensePlate") query = db.collection("users").where("vehicles", "array-contains", { plate: searchValue });
            if (searchBy === "phone") query = db.collection("users").where("phone", "==", searchValue);

            query.get().then(snapshot => {
                snapshot.forEach(doc => displayDetails(doc.data()));
            }).catch(err => alert("Error: " + err));
        });

        // Display User Details
        function displayDetails(user) {
            document.getElementById("uid").value = user.uid || "";
            document.getElementById("email").value = user.email || "";
            document.getElementById("department").value = user.department || "";
            document.getElementById("municipality").value = user.municipality || "";
            document.getElementById("phone").value = user.phone || "";
            document.getElementById("planType").value = user.planType || "";
            document.getElementById("registrationDate").value = user.registrationDate.toDate().toLocaleString() || "";
            document.getElementById("lastReschedule").value = user.lastReschedule.toDate().toLocaleString() || "";
            document.getElementById("paymentDate").value = user.paymentDate.toDate().toISOString().split("T")[0] || "";
            document.getElementById("nextPaymentDate").value = user.nextPaymentDate.toDate().toLocaleString() || "";

            const vehicle = user.vehicles ? user.vehicles[0] : {};
            document.getElementById("vehiclePlate").value = vehicle.plate || "";
            document.getElementById("vehicleBrand").value = vehicle.brand || "";
            document.getElementById("vehicleModel").value = vehicle.model || "";
            document.getElementById("vehicleYear").value = vehicle.year || "";

            document.getElementById("user-details").style.display = "block";
        }

        // Update User Data
        function updateUserData() {
            const email = document.getElementById("email").value;

            const updatedData = {
                department: document.getElementById("department").value,
                municipality: document.getElementById("municipality").value,
                phone: document.getElementById("phone").value,
                planType: document.getElementById("planType").value,
                paymentDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById("paymentDate").value)),
            };

            db.collection("users").doc(email).update(updatedData)
                .then(() => alert("Datos actualizados correctamente"))
                .catch(err => console.error("Error: ", err));
        }

        function logout() {
            auth.signOut().then(() => window.location.href = "login.html");
        }
    </script>
</body>
</html>
