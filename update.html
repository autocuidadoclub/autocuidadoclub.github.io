<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Actualizar Usuarios</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="/env.js"></script> <!-- your env.js must define firebaseConfig -->

</head>
<body>
  <h1>Actualizar Usuarios Existentes</h1>
  <button onclick="updateExistingUsers()">Actualizar Ahora</button>

  <script>

    
  const firebaseConfig = {
    apiKey: "AIzaSyD...",
    authDomain: "your-project-id.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef123456"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // your updateExistingUsers() function here

    // Initialize Firebase only once
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Define the function after Firebase is initialized
    async function updateExistingUsers() {
      const usersRef = db.collection("users");
      const querySnapshot = await usersRef.get();

      for (const userDoc of querySnapshot.docs) {
        const userData = userDoc.data();
        const updates = {};

        if (!userData.department) updates.department = "Morazán";
        if (!userData.freeRescheduleClaimed) updates.freeRescheduleClaimed = false;
        if (!userData.lastLoyaltyReset) updates.lastLoyaltyReset = firebase.firestore.Timestamp.now();
        if (!userData.lastUpgradeDate) updates.lastUpgradeDate = firebase.firestore.Timestamp.now();
        if (!userData.loyaltyCycle && userData.loyaltyCycle !== 0) updates.loyaltyCycle = 0;
        if (!userData.monthsPaid && userData.monthsPaid !== 0) updates.monthsPaid = 0;
        if (!userData.nextCyclePrice && userData.nextCyclePrice !== 0) updates.nextCyclePrice = 0;
        if (!userData.paymentHistory) updates.paymentHistory = [];
        if (!userData.stripeCustomerId) updates.stripeCustomerId = "";
        if (!userData.founderPhase) updates.founderPhase = true;
        if (!userData.referralBonusAvailable) updates.referralBonusAvailable = false;
        if (!userData.referralsCompleted && userData.referralsCompleted !== 0) updates.referralsCompleted = 0;
        if (!userData.plusReferralsCompleted && userData.plusReferralsCompleted !== 0) updates.plusReferralsCompleted = 0;
        if (!userData.referredBy) updates.referredBy = "";

        if (!userData.vehicles) {
          updates.vehicles = [{
            brand: "",
            model: "",
            plate: "",
            year: "",
            inspectionDates: []
          }];
        }

        if (!userData.schedule) {
          updates.schedule = {
            day: "",
            time: ""
          };
        }

        if (Object.keys(updates).length > 0) {
          await userDoc.ref.update(updates);
          console.log(`✅ Updated user: ${userDoc.id}`, updates);
        }
      }

      alert("✅ Todos los usuarios actualizados exitosamente.");
    }
  </script>
</body>
</html>
