<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AutoCuidado Club</title>
    <link rel="stylesheet" href="/styles.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Load Environment Variables -->
    <script src="env.js"></script>

    <!-- Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .navbar {
            background-color: #003366;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }

        .nav-links li {
            margin-right: 15px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }

        .card {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            background: #ffffff;
            margin-bottom: 20px;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
        }

        .highlight-text {
            color: #FF6600;
            font-weight: bold;
        }

        .payment-warning {
            background-color: #ffebe6;
            color: red;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-weight: bold;
        }

        .floating-contact-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ff6600;
            color: white;
            padding: 12px 18px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .floating-contact-button:hover {
            background-color: #cc5500;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="nosotros.html">Nosotros</a></li>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="servicios.html">Servicios</a></li>
            <li><a href="suscripciones.html">Conoce Nuestras Suscripciones</a></li>
            <li><a href="contacto.html">Contacto</a></li>
        </ul>
    </nav>

    <header>
        <h2 id="user-info">Cargando usuario...</h2>
        <button onclick="logoutUser()">Cerrar Sesión</button>
    </header>

    <!-- User Dashboard -->
    <section class="dashboard-section">
        <div class="card">
            <h3><i class="fas fa-user"></i> Información del Usuario</h3>
            <p><strong>Nombre:</strong> <span id="name">Cargando...</span></p>
            <p><strong>Teléfono:</strong> <span id="phone">Cargando...</span></p>
            <p><strong>Departamento:</strong> <span id="user-department">Cargando...</span></p>
            <p><strong>Municipio:</strong> <span id="user-municipality">Cargando...</span></p>
            <p><strong>Plan Actual:</strong> <span id="planType">Cargando...</span></p>
        </div>

        <div class="card">
            <h3><i class="fas fa-credit-card"></i> Estado de Pago</h3>
            <p><strong>Fecha del Último Pago:</strong> <span id="paymentDate">Cargando...</span></p>
            <p><strong>Próximo Pago:</strong> <span id="nextPaymentDate">Cargando...</span></p>
            <div id="payment-warning" class="payment-warning" style="display: none;">
                ¡Estamos esperándote! ⚠️ Solo realiza tu pago y nos encargamos de todo. 🚗🔧
                <a id="payment-link" href="#">Completa tu pago ahora 🔥</a>
            </div>
        </div>

        <div class="card">
            <h3>Suscripción</h3>
            <p><strong>Tipo de Plan Actual:</strong> <span id="planType">Cargando...</span></p>
            <button onclick="upgradePlan()">Mejorar Plan</button>
        </div>
    </section>

    <!-- Floating Contact Button -->
    <button class="floating-contact-button" onclick="window.open('contacto.html', '_blank');">
        <i class="fas fa-headset"></i> Contactar Staff
    </button>

    <script>
        let auth, db;

        // Initialize Firebase
        document.addEventListener("DOMContentLoaded", function () {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();

            auth.onAuthStateChanged((user) => {
                if (user) {
                    loadUserProfile(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });
        });

        function loadUserProfile(uid) {
            db.collection("users").doc(uid).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    document.getElementById("name").innerText = userData.name || "N/A";
                    document.getElementById("phone").innerText = userData.phone || "N/A";
                    document.getElementById("user-department").innerText = userData.department || "Desconocido";
                    document.getElementById("user-municipality").innerText = userData.municipality || "Desconocido";
                    document.getElementById("planType").innerText = userData.planType || "N/A";
                    document.getElementById("paymentDate").innerText = formatTimestamp(userData.paymentDate);
                    document.getElementById("nextPaymentDate").innerText = formatTimestamp(userData.nextPaymentDate);
                    
                    handlePaymentStatus(userData);
                }
            });
        }

        function handlePaymentStatus(userData) {
            if (userData.paymentStatus === "Pending") {
                document.getElementById("payment-warning").style.display = "block";
                document.getElementById("payment-link").href = getPaypalLink(userData.planType);
            }
        }

        function getPaypalLink(planType) {
            const payPalLinks = {
                "basic3m": "https://www.paypal.com/pay/basic3m",
                "basic6m": "https://www.paypal.com/pay/basic6m",
                "basic12m": "https://www.paypal.com/pay/basic12m"
            };
            return payPalLinks[planType] || "#";
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return "N/A";
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            return date.toLocaleDateString("es-ES");
        }

        function logoutUser() {
            auth.signOut().then(() => {
                window.location.href = "login.html";
            });
        }
    </script>
</body>
</html>
