# .github/workflows/deploy.yml
name: ðŸš€ Deploy AutoCuidado Club

on:
  push:
    branches: [main]

jobs:
  deploy_hosting:
    name: Deploy Firebase Hosting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate env.js
        run: |
          mkdir -p public
          cat <<EOF > public/env.js
          window._env_ = {
            FIREBASE_API_KEY:      "${{ secrets.FIREBASE_API_KEY }}",
            FIREBASE_AUTH_DOMAIN:  "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            FIREBASE_PROJECT_ID:   "${{ secrets.FIREBASE_PROJECT_ID }}",
            FIREBASE_STORAGE_BUCKET:"${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            FIREBASE_MESSAGING_SENDER_ID:"${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            FIREBASE_APP_ID:       "${{ secrets.FIREBASE_APP_ID }}",
            FIREBASE_MEASUREMENT_ID:"${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          EOF

      - name: Decode Service Account
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" | base64 -d > $HOME/service-account.json

      - name: Authenticate gcloud
        run: |
          curl -sSL https://sdk.cloud.google.com | bash > /dev/null
          source $HOME/google-cloud-sdk/path.bash.inc
          gcloud auth activate-service-account --key-file=$HOME/service-account.json
          gcloud config set project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      - name: Deploy to Firebase Hosting
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $HOME/service-account.json
        run: firebase deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }}

  deploy_github_pages:
    name: Deploy to GitHub Pages
    needs: deploy_hosting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Copy Hosting output to public/
        run: |
          mkdir -p public
          cp -r public/* public/  # if your hosting build is in public/
      - name: Push to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public

  deploy_functions:
    name: Deploy Firebase Functions
    needs: deploy_hosting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Decode Service Account
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" | base64 -d > $HOME/service-account.json

      - name: Authenticate gcloud
        run: |
          curl -sSL https://sdk.cloud.google.com | bash > /dev/null
          source $HOME/google-cloud-sdk/path.bash.inc
          gcloud auth activate-service-account --key-file=$HOME/service-account.json
          gcloud config set project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      - name: Deploy Cloud Functions
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $HOME/service-account.json
        run: firebase deploy --only functions --project ${{ secrets.FIREBASE_PROJECT_ID }}
