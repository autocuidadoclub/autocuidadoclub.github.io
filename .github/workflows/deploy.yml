  deploy_github_pages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up GitHub Pages
        run: |
          mkdir -p public
          cp index.html public/index.html

      - name: Deploy GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public

  deploy_functions:  # ← ❗ ESTA LÍNEA ESTABA MAL INDENTADA
    runs-on: ubuntu-latest
    needs: deploy_firebase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Decode Firebase Service Account
        run: echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" | base64 --decode > $HOME/service-account.json

      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      - name: Set Firebase Functions Config from GitHub Secrets
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/service-account.json
          firebase functions:config:set \
            "stripe.secret=${{ secrets.STRIPE_SECRET_KEY }}" \
            "stripe.webhook=${{ secrets.STRIPE_WEBHOOK_SECRET }}" \
            "zoho.client_id=${{ secrets.ZOHO_CLIENT_ID }}" \
            "zoho.client_secret=${{ secrets.ZOHO_CLIENT_SECRET }}" \
            "zoho.refresh_token=${{ secrets.ZOHO_REFRESH_TOKEN }}" \
            "zoho.api_domain=${{ secrets.ZOHO_API_DOMAIN }}" \
            "zoho.user_id=${{ secrets.ZOHO_USER_ID }}" \
            "app.url=https://autocuidadoclub.com" \
            --project="${{ secrets.FIREBASE_PROJECT_ID }}"

      - name: Deploy Firebase Functions
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/service-account.json
          firebase deploy --only functions --project="${{ secrets.FIREBASE_PROJECT_ID }}"
