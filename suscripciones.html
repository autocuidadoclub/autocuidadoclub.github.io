<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conoce Nuestras Suscripciones - AutoCuidado Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Firebase Compatibility SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
         const firebaseConfig = {
          apiKey: "AIzaSyBsYS6pHWaTgXzdml-H_y3lQewWgOUezPM",
          authDomain: "auto-cuidadoclub.firebaseapp.com",
          databaseURL: "https://auto-cuidadoclub-default-rtdb.firebaseio.com",
          projectId: "auto-cuidadoclub",
          storageBucket: "auto-cuidadoclub.appspot.com",
          messagingSenderId: "986704701191",
          appId: "1:986704701191:web:fc96ef678d64c1cdcf47a2",
          measurementId: "G-LBBGXV2YX5"
        };


        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function showRegistrationForm(planType) {
            document.getElementById('register-section').style.display = 'block';
            document.getElementById('planType').value = planType;

            const vehicleSections = document.getElementById('vehicle-sections');
            vehicleSections.innerHTML = '';
            const vehicleCount = planType.startsWith("plus") ? 3 : 1;
            for (let i = 1; i <= vehicleCount; i++) {
                vehicleSections.insertAdjacentHTML('beforeend', `
                    <div class="vehicle-info">
                        <h4>Información del Vehículo ${i}</h4>
                        <label for="vehicleBrand${i}">Marca:</label>
                        <input type="text" id="vehicleBrand${i}" class="vehicleBrand" required>
                        <label for="vehicleModel${i}">Modelo:</label>
                        <input type="text" id="vehicleModel${i}" class="vehicleModel" required>
                        <label for="vehicleYear${i}">Año:</label>
                        <input type="text" id="vehicleYear${i}" class="vehicleYear" required pattern="\\d{4}" title="Cuatro dígitos">
                        <label for="vehiclePlate${i}">Placa:</label>
                        <input type="text" id="vehiclePlate${i}" class="vehiclePlate" required>
                    </div>
                `);
            }
        }

        function registerAndPay() {
            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const phone = document.getElementById("phone").value;
            const planType = document.getElementById("planType").value;
            const password = document.getElementById("password").value;
            const vehicles = Array.from(document.querySelectorAll('.vehicle-info')).map(vehicleSection => ({
                brand: vehicleSection.querySelector('.vehicleBrand').value,
                model: vehicleSection.querySelector('.vehicleModel').value,
                year: vehicleSection.querySelector('.vehicleYear').value,
                plate: vehicleSection.querySelector('.vehiclePlate').value,
            }));

            if (!name || !email || !phone || !password) {
                alert("Por favor, complete todos los campos.");
                return;
            }

            const userData = { name, email, phone, planType, vehicles, subscriptionStatus: "active" };
            const usersRef = db.collection("users");

            usersRef.doc(email).get()
                .then(doc => {
                    if (doc.exists) {
                        const user = doc.data();
                        if (user.subscriptionStatus === "active" && user.planType === planType) {
                            throw new Error("Ya tienes una suscripción activa para este plan.");
                        }
                        if (user.planType.startsWith("plus") && planType.startsWith("basic") && user.subscriptionStatus === "active") {
                            throw new Error("No puedes cambiar de un plan Plus a un plan Básico mientras tu suscripción esté activa.");
                        }
                        if (user.subscriptionStatus === "expired" || planType.startsWith("plus")) {
                            userData.subscriptionHistory = user.subscriptionHistory || [];
                            userData.subscriptionHistory.push({ ...user });
                        }
                    }
                    return firebase.auth().createUserWithEmailAndPassword(email, password);
                })
                .then(userCredential => {
                    const newUser = userCredential.user;
                    userData.uid = newUser.uid;
                    return usersRef.doc(email).set(userData);
                })
                .then(() => {
                    alert("Registro exitoso. Presiona OK para proceder al pago.");
                    window.open(getPaypalLink(planType), '_blank');
                })
                .catch(error => {
                    console.error("Error:", error.message);
                    alert(error.message);
                });
        }

        function getPaypalLink(planType) {
            switch (planType) {
                case "basic3m": return "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=ID_BASIC_3M";
                case "basic6m": return "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=ID_BASIC_6M";
                case "basic12m": return "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=ID_BASIC_12M";
                case "plus3m": return "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=ID_PLUS_3M";
                case "plus6m": return "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=ID_PLUS_6M";
                case "plus12m": return "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=ID_PLUS_12M";
                default: alert("Plan inválido."); return null;
            }
        }
    </script>
</head>
<body>
    <nav>
        <!-- Navbar -->
    </nav>
    <header>
        <!-- Header -->
    </header>
    <section class="subscription-section">
        <h2>Planes de Suscripción</h2>
        <!-- Subscription Plan Buttons -->
        <button onclick="showRegistrationForm('basic3m')">Plan Básico 3 Meses</button>
        <button onclick="showRegistrationForm('plus3m')">Plan Plus 3 Meses</button>
    </section>
    <section id="register-section" style="display: none;">
        <h2>Registro</h2>
        <form onsubmit="registerAndPay(); return false;">
            <label>Nombre: <input id="name" type="text" required></label>
            <label>Email: <input id="email" type="email" required></label>
            <label>Teléfono: <input id="phone" type="text" required></label>
            <label>Contraseña: <input id="password" type="password" required></label>
            <input id="planType" type="hidden">
            <div id="vehicle-sections"></div>
            <button type="submit">Registrarse y Pagar</button>
        </form>
    </section>
    <footer>
        <!-- Footer -->
    </footer>
</body>
</html>
