<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBsYS6pHWaTgXzdml-H_y3lQewWgOUezPM",
        authDomain: "auto-cuidadoclub.firebaseapp.com",
        projectId: "auto-cuidadoclub",
        storageBucket: "auto-cuidadoclub.appspot.com",
        messagingSenderId: "986704701191",
        appId: "1:986704701191:web:fc96ef678d64c1cdcf47a2",
        measurementId: "G-LBBGXV2YX5"
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();

      const totalMechanics = 10;

      // Available time slots for each day
      const availableSlots = {
        "Monday": ["9:00 - 11:00", "12:00 - 14:00", "15:00 - 17:00"],
        "Wednesday": ["10:00 - 12:00", "13:00 - 15:00", "16:00 - 18:00"],
        "Friday": ["13:00 - 15:00", "16:00 - 18:00"],
        "Saturday": ["8:00 - 10:00", "11:00 - 13:00", "14:00 - 16:00"],
        "Sunday": ["9:00 - 11:00", "12:00 - 14:00"]
      };

      function bookSlot(day, time, municipio) {
        const userId = auth.currentUser.uid;

        db.ref('users/' + userId).once('value').then((snapshot) => {
          const userData = snapshot.val();
          const subscriptionType = userData.subscriptionType;
          const currentMonthBookings = userData.currentMonthBookings || 0;
          const maxBookings = (subscriptionType === 'basic') ? 1 : 3;

          if (currentMonthBookings >= maxBookings) {
            alert("Has alcanzado el límite de reservas para este mes.");
          } else {
            // Check if the time slot has availability (mechanics available)
            db.ref('bookings/' + day + ' ' + time).once('value').then((snapshot) => {
              const bookings = snapshot.val() || {};
              const mechanicsAvailable = Object.keys(bookings).length < totalMechanics;

              if (mechanicsAvailable) {
                alert("Has reservado: " + time + " en " + day);
                
                db.ref('bookings/' + day + ' ' + time + '/' + userId).set({
                  booked: true,
                  user: userId,
                  vehicle: userData.vehicle,
                  municipio: municipio
                });

                db.ref('users/' + userId).update({
                  currentMonthBookings: currentMonthBookings + 1
                });

              } else {
                alert("Este horario ya está completo. Elige otro horario.");
              }
            });
          }
        });
      }

      function sendReminder(userId, bookingDate) {
        alert("Recordatorio: Tu próxima inspección es el " + bookingDate);
      }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCuidado Club - Calendario de Reservas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<section id="calendar">
    <h2>Calendario de Reservas</h2>
    <p>Consulta la disponibilidad de bloques de tiempo y selecciona el que más te convenga.</p>

    <table id="booking-calendar">
        <tr>
            <th>Lunes</th>
            <th>Miércoles</th>
            <th>Viernes</th>
            <th>Sábado</th>
            <th>Domingo</th>
        </tr>
        <tr>
            <td><button class="available" onclick="bookSlot('Monday', '9:00 - 11:00', 'San Salvador')">9:00 - 11:00</button></td>
            <td><button class="available" onclick="bookSlot('Wednesday', '10:00 - 12:00', 'Santa Tecla')">10:00 - 12:00</button></td>
            <td><button class="available" onclick="bookSlot('Friday', '13:00 - 15:00', 'San Salvador')">13:00 - 15:00</button></td>
            <td><button class="available" onclick="bookSlot('Saturday', '8:00 - 10:00', 'Soyapango')">8:00 - 10:00</button></td>
            <td><button class="available" onclick="bookSlot('Sunday', '9:00 - 11:00', 'Santa Ana')">9:00 - 11:00</button></td>
        </tr>
    </table>
</section>

</body>
</html>
