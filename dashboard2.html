<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AutoCuidado Club</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Load Environment Variables -->
    <script src="env.js"></script>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
</head>
<body>

<!-- Navigation -->
<nav class="navbar">
    <ul class="nav-links">
        <li><a href="nosotros.html">Nosotros</a></li>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="servicios.html">Servicios</a></li>
        <li><a href="suscripciones.html">Conoce Nuestras Suscripciones</a></li>
        <li><a href="contacto.html">Contacto</a></li>
    </ul>
    <div class="logo-container">
        <img src="logo.jpg" alt="AutoCuidado Club Logo" class="logo">
    </div>
</nav>

<!-- Header -->
<header>
    <div class="header-container">
        <h2 id="user-info">Cargando usuario...</h2>
        <button id="logout-btn">Cerrar Sesión</button>
    </div>
</header>

<!-- Dashboard Content -->
<section class="dashboard-section">
    <div class="dashboard-grid">
        <div class="card">
            <h3>Información del Usuario</h3>
            <p><strong>Nombre:</strong> <span id="userName">Cargando...</span></p>
            <p><strong>Teléfono:</strong> <span id="userPhone">Cargando...</span></p>
            <p><strong>Departamento:</strong> <span id="userDepartment">Cargando...</span></p>
            <p><strong>Municipio:</strong> <span id="userMunicipality">Cargando...</span></p>
            <p><strong>Vehículos:</strong> <span id="userVehicles">Cargando...</span></p>
        </div>

        <div class="card">
            <h3>Estado de Pago</h3>
            <p><strong>Miembro Desde:</strong> <span id="memberSince">Cargando...</span></p>
            <p><strong>Último Pago:</strong> <span id="lastPaymentDate">Cargando...</span></p>
            <p><strong>Próximo Pago:</strong> <span id="nextPayment">Cargando...</span></p>
            <p><strong>Tipo de Plan:</strong> <span id="planType">Cargando...</span></p>
        </div>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("✅ DOM fully loaded!");

    if (typeof window._env_ === "undefined" || !window._env_.FIREBASE_API_KEY) {
        console.error("❌ Error: Firebase env.js not loaded.");
        alert("❌ Firebase is not initialized. Check env.js.");
        return;
    }

    const firebaseConfig = {
        apiKey: window._env_.FIREBASE_API_KEY,
        authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
        projectId: window._env_.FIREBASE_PROJECT_ID,
        storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
        messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
        appId: window._env_.FIREBASE_APP_ID,
        measurementId: window._env_.FIREBASE_MEASUREMENT_ID
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("✅ Firebase initialized successfully!");
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged((user) => {
        if (!user) {
            console.warn("⚠ No user logged in. Redirecting to login...");
            setTimeout(() => {
                window.location.href = "login.html";
            }, 100);
            return;
        }

        console.log(`✅ Logged in as: ${user.email}`);
        loadUserProfile(user.uid);
    });

    function loadUserProfile(uid) {
        db.collection("users").doc(uid).get().then((doc) => {
            if (doc.exists) {
                const userData = doc.data();
                console.log("✅ User data retrieved:", userData);

                document.getElementById("userName").textContent = userData.name || "No registrado";
                document.getElementById("userPhone").textContent = userData.phone || "No registrado";
                document.getElementById("userDepartment").textContent = userData.department || "No registrado";
                document.getElementById("userMunicipality").textContent = userData.municipality || "No registrado";
                document.getElementById("userVehicles").textContent = userData.vehicles ? userData.vehicles.map(v => v.plate).join(", ") : "No registrado";
                
                document.getElementById("memberSince").textContent = formatTimestamp(userData.registrationDate);
                document.getElementById("lastPaymentDate").textContent = formatTimestamp(userData.paymentDate);
                document.getElementById("nextPayment").textContent = formatTimestamp(userData.nextPaymentDate);
                document.getElementById("planType").textContent = userData.planType || "No registrado";
            } else {
                console.warn("⚠ No user data found in Firestore.");
                alert("⚠ No se encontró información del usuario en la base de datos.");
            }
        }).catch((error) => {
            console.error("❌ Error fetching user data:", error);
            alert("❌ Error al cargar los datos del usuario. Intenta de nuevo.");
        });
    }

    function formatTimestamp(timestamp) {
        if (!timestamp) return "No disponible";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString("es-ES");
    }

    document.getElementById("logout-btn").addEventListener("click", function () {
        auth.signOut().then(() => {
            console.log("✅ User logged out successfully.");
            sessionStorage.clear();
            window.location.href = "login.html";
        }).catch((error) => {
            console.error("❌ Error during logout:", error.message);
            alert("❌ Error al cerrar sesión: " + error.message);
        });
    });

    setTimeout(() => {
        if (!firebase.auth().currentUser) {
            console.warn("⚠ Firebase Auth taking too long... reloading.");
            window.location.reload();
        }
    }, 5000);
});
</script>

<footer>
    <p>&copy; 2024 AutoCuidado Club - Todos los derechos reservados.</p>
</footer>

</body>
</html>
