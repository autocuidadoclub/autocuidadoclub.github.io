<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro en AutoCuidado Club</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- ‚úÖ Force Load env.js to Prevent Caching Issues -->
    <script src="env.js?v=1.0"></script>

    <script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof window._env_ === "undefined" || !window._env_.FIREBASE_API_KEY) {
        console.error("‚ùå Error: Firebase env.js not loaded.");
        alert("‚ùå Firebase is not initialized. Check env.js.");
        return;
    }

    const firebaseConfig = {
        apiKey: window._env_.FIREBASE_API_KEY,
        authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
        projectId: window._env_.FIREBASE_PROJECT_ID,
        storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
        messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
        appId: window._env_.FIREBASE_APP_ID,
        measurementId: window._env_.FIREBASE_MEASUREMENT_ID
    };

      console.log("üî• Checking Firebase SDK...");
console.log("üî• Firebase Apps:", firebase.apps);
console.log("üî• Firebase Auth Instance:", typeof firebase.auth !== "undefined" ? firebase.auth() : "‚ùå Firebase Auth NOT LOADED");
console.log("üî• Firebase Firestore Instance:", typeof firebase.firestore !== "undefined" ? firebase.firestore() : "‚ùå Firestore NOT LOADED");
     
      
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("‚úÖ Firebase initialized successfully!");
    } else {
        console.log("‚ÑπÔ∏è Firebase already initialized.");
    }
});

    // ‚úÖ Check Authentication
    try {
        const auth = firebase.auth();
        console.log("‚úÖ Firebase Auth Loaded:", auth);
    } catch (error) {
        console.error("üî• Firebase Auth Error:", error);
    }

    // ‚úÖ Check Firestore
    try {
        const db = firebase.firestore();
        console.log("‚úÖ Firestore Loaded:", db);
    } catch (error) {
        console.error("üî• Firestore Error:", error);
    }
});

        // ‚úÖ Firebase References
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ‚úÖ Function to Select Schedule Box
        window.selectScheduleBox = function(cell, day, time) {
            document.querySelectorAll(".schedule-table td").forEach(td => td.classList.remove("selected"));
            cell.classList.add("selected");
            document.getElementById("selectedDay").value = day;
            document.getElementById("selectedTime").value = time;
        };

        // ‚úÖ Function to Register User
        document.getElementById("registerForm").addEventListener("submit", function(event) {
            event.preventDefault();

            const name = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();
            const phone = document.getElementById("phone").value.trim();
            const password = document.getElementById("password").value.trim();
            const planType = document.getElementById("planType").value;
            const selectedDay = document.getElementById("selectedDay").value;
            const selectedTime = document.getElementById("selectedTime").value;

             const vehicles = [];
            document.querySelectorAll(".vehicle-entry").forEach(entry => {
                vehicles.push({
                    plate: entry.querySelector(".plate").value,
                    model: entry.querySelector(".model").value,
                    brand: entry.querySelector(".brand").value,
                    year: entry.querySelector(".year").value
                });
            });

            if (!name || !email || !phone || !password || !selectedDay || !selectedTime) {
                alert("‚ùå Todos los campos son obligatorios.");
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const userId = userCredential.user.uid;
                    console.log("‚úÖ Usuario registrado:", userId);

                    return db.collection("users").doc(userId).set({
                         uid: userId,
                        name,
                        email,
                        phone,
                        planType,
                        schedule: { day: selectedDay, time: selectedTime },
                        registrationDate: firebase.firestore.Timestamp.now(),
                        vehicles
                    });
                })
                .then(() => {
                    alert("‚úÖ Registro exitoso. Redirigiendo...");
                    window.location.href = "login.html";
                })
                .catch((error) => {
                    console.error("‚ùå Error en el registro:", error.message);
                    alert("‚ùå Error en el registro: " + error.message);
                });
        });
    });
    </script>

</head>

<body>

    <h2>Registro en AutoCuidado Club</h2>
    <form id="registerForm" onsubmit="registerUser(event)">
        <label>Nombre:</label>
        <input type="text" id="name" required>

        <label>Email:</label>
        <input type="email" id="email" required>

        <label>Tel√©fono:</label>
        <input type="text" id="phone" required>

        <label>Contrase√±a:</label>
        <input type="password" id="password" required>

        <label>Selecciona tu Plan:</label>
        <select id="planType">
            <option value="basic3m">Basic - 1 Veh√≠culo</option>
            <option value="plus3m">Plus - Hasta 3 Veh√≠culos</option>
        </select>

        <div id="vehicle-section">
    <h3>Datos del Veh√≠culo</h3>
    <div id="vehicle-container">
        <div class="vehicle-entry">
            <label for="plate">Placa:</label>
            <input type="text" class="plate" required>

            <label for="model">Modelo:</label>
            <input type="text" class="model" required>

            <label for="brand">Marca:</label>
            <input type="text" class="brand" required>

            <label for="year">A√±o:</label>
            <input type="number" class="year" required>
        </div>
    </div>
    <button type="button" onclick="addVehicle()">A√±adir Veh√≠culo</button>
</div>

        <!-- Schedule Section -->
    <section id="schedule-section" class="schedule-section">
        <h2>Selecciona tu Horario</h2>
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>Horario</th>
                    <th>Lunes</th>
                    <th>Mi√©rcoles</th>
                    <th>Viernes</th>
                    <th>S√°bado</th>
                    <th>Domingo</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Bloque 1</td>
                    <td onclick="selectScheduleBox(this)">9:00 - 11:00</td>
                    <td onclick="selectScheduleBox(this)">10:00 - 12:00</td>
                    <td onclick="selectScheduleBox(this)">13:00 - 15:00</td>
                    <td onclick="selectScheduleBox(this)">8:00 - 10:00</td>
                    <td onclick="selectScheduleBox(this)">9:00 - 11:00</td>
                </tr>
                <tr>
                    <td>Bloque 2</td>
                    <td onclick="selectScheduleBox(this)">12:00 - 14:00</td>
                    <td onclick="selectScheduleBox(this)">13:00 - 15:00</td>
                    <td onclick="selectScheduleBox(this)">16:00 - 18:00</td>
                    <td onclick="selectScheduleBox(this)">11:00 - 13:00</td>
                    <td onclick="selectScheduleBox(this)">12:00 - 14:00</td>
                </tr>
                <tr>
                    <td>Bloque 3</td>
                    <td onclick="selectScheduleBox(this)">15:00 - 17:00</td>
                    <td onclick="selectScheduleBox(this)">16:00 - 18:00</td>
                    <td onclick="selectScheduleBox(this)">-</td>
                    <td onclick="selectScheduleBox(this)">14:00 - 16:00</td>
                    <td onclick="selectScheduleBox(this)">-</td>
                </tr>
            </tbody>
        </table>

        <input type="hidden" id="selectedDay" required>
        <input type="hidden" id="selectedTime" required>

        <div class="card">
    <h3>Seleccione su Ubicaci√≥n</h3>
    <label for="department">Departamento:</label>
    <select id="department" onchange="updateMunicipalities()" required>
        <option value="">Seleccione un departamento</option>
    </select>
    
    <label for="municipality">Municipio:</label>
    <select id="municipality" required>
        <option value="">Seleccione un municipio</option>
    </select>
    
    
    <script>
        const locations = {
            "Ahuachap√°n": ["Ahuachap√°n", "Apaneca", "Atiquizaya", "Concepci√≥n de Ataco", "El Refugio", "Guaymango", "Jujutla", "San Francisco Men√©ndez", "San Lorenzo", "San Pedro Puxtla", "Tacuba", "Tur√≠n"],
            "Santa Ana": ["Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "Masahuat", "Metap√°n", "San Antonio Pajonal", "San Sebasti√°n Salitrillo", "Santa Ana", "Santa Rosa Guachipil√≠n", "Texistepeque"],
            "Sonsonate": ["Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "Juay√∫a", "Nahuizalco", "Nahulingo", "Salcoatit√°n", "San Antonio del Monte", "San Juli√°n", "Santa Catarina Masahuat", "Santa Isabel Ishuat√°n", "Santo Domingo de Guzm√°n", "Sonsonate", "Sonzacate"],
            "Chalatenango": ["Agua Caliente", "Arcatao", "Azacualpa", "Chalatenango", "Cital√°", "Comalapa", "Concepci√≥n Quezaltepeque", "Dulce Nombre de Mar√≠a", "El Carrizal", "El Para√≠so", "La Laguna", "La Palma", "Las Flores", "Las Vueltas", "Nueva Concepci√≥n", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco Moraz√°n", "San Ignacio", "San Isidro Labrador", "San Jos√© Cancasque", "San Jos√© Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],
            "Cuscatl√°n": ["Candelaria", "Cojutepeque", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de Concepci√≥n", "San Bartolom√© Perulap√≠a", "San Crist√≥bal", "San Jos√© Guayabal", "San Pedro Perulap√°n", "San Rafael Cedros", "San Ram√≥n", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo"],
            "San Salvador": ["Aguilares", "Apopa", "Ayutuxtepeque", "Ciudad Delgado", "Cuscatancingo", "El Paisnal", "Guazapa", "Ilopango", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San Mart√≠n", "San Salvador", "Santiago Texacuangos", "Santo Tom√°s", "Soyapango", "Tonacatepeque"],
            "La Libertad": ["Antiguo Cuscatl√°n", "Chiltiup√°n", "Ciudad Arce", "Col√≥n", "Comasagua", "Huiz√∫car", "Jayaque", "Jicalapa", "La Libertad", "Nuevo Cuscatl√°n", "San Juan Opico", "Quezaltepeque", "Sacacoyo", "San Jos√© Villanueva", "San Mat√≠as", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],
            "San Vicente": ["Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San Sebasti√°n", "San Vicente", "Santa Clara", "Santo Domingo", "Tecoluca", "Tepetit√°n", "Verapaz"],
            "Caba√±as": ["Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Sensuntepeque", "Tejutepeque", "Victoria"],
            "Usulut√°n": ["Alegr√≠a", "Berl√≠n", "California", "Concepci√≥n Batres", "El Triunfo", "Ereguayqu√≠n", "Estanzuelas", "Jiquilisco", "Jucuapa", "Jucuar√°n", "Mercedes Uma√±a", "Nueva Granada", "Ozatl√°n", "Puerto El Triunfo", "San Agust√≠n", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa Mar√≠a", "Santiago de Mar√≠a", "Tecap√°n", "Usulut√°n"],
            "San Miguel": ["Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "Comacar√°n", "El Tr√°nsito", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo Ed√©n de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Miguel", "San Rafael Oriente", "Sesori", "Uluazapa"],
            "Moraz√°n": ["Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de Concepci√≥n", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Lolotiquillo", "Meanguera", "Osicala", "Perqu√≠n", "San Carlos", "San Fernando", "San Francisco Gotera", "San Isidro", "San Sim√≥n", "Sensembra", "Sociedad", "Torola", "Yamabal", "Yoloaiqu√≠n"],
            "La Uni√≥n": ["Anamor√≥s", "Bol√≠var", "Concepci√≥n de Oriente", "Conchagua", "El Carmen", "El Sauce", "Intipuc√°", "La Uni√≥n", "Lislique", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "Polor√≥s", "San Alejo", "San Jos√©", "Santa Rosa de Lima", "Yayantique", "Yucuaiqu√≠n"]
        };
        const departmentSelect = document.getElementById("department");
        const municipalitySelect = document.getElementById("municipality");

        // Populate the departments dropdown
        function populateDepartments() {
            for (const department in locations) {
                const option = document.createElement("option");
                option.value = department;
                option.textContent = department;
                departmentSelect.appendChild(option);
            }
        }

        // Update municipalities based on selected department
        function updateMunicipalities() {
            const selectedDepartment = departmentSelect.value;
            municipalitySelect.innerHTML = '<option value="">Seleccione un municipio</option>'; // Reset municipalities

            if (locations[selectedDepartment]) {
                locations[selectedDepartment].forEach(municipality => {
                    const option = document.createElement("option");
                    option.value = municipality;
                    option.textContent = municipality;
                    municipalitySelect.appendChild(option);
                });
            }
        }

        // Initialize departments on page load
        document.addEventListener("DOMContentLoaded", populateDepartments);

        function addVehicle() {
        const vehicleContainer = document.getElementById("vehicle-container");
        if (vehicleContainer.children.length >= 3) {
            alert("Solo puedes agregar hasta 3 veh√≠culos.");
            return;
        }

        const newVehicle = document.createElement("div");
        newVehicle.classList.add("vehicle-entry");
        newVehicle.innerHTML = `
            <label for="plate">Placa:</label>
            <input type="text" class="plate" required>

            <label for="model">Modelo:</label>
            <input type="text" class="model" required>

            <label for="brand">Marca:</label>
            <input type="text" class="brand" required>

            <label for="year">A√±o:</label>
            <input type="number" class="year" required>

            <button type="button" onclick="removeVehicle(this)">Eliminar</button>
        `;
        vehicleContainer.appendChild(newVehicle);
    }

    function removeVehicle(button) {
        button.parentElement.remove();
    }
        
    </script>

<!-- Checkbox for Terms and Conditions -->
    <div style="margin-top: 15px;">
        <input type="checkbox" id="terms" name="terms" required>
        <label for="terms">
            He le√≠do y acepto los <a href="tac.html" target="_blank">T√©rminos y Condiciones</a>.
        </label>
    </div>
            
        <button type="submit">Registrarse</button>
    </form>

</body>
</html>
