<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AutoCuidado Club - Tu servicio experto de mantenimiento personalizado para veh√≠culos en El Salvador. Sin talleres. Sin filas. Sin excusas.">

    <title>Dashboard - AutoCuidado Club</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
     <!-- Load Environment Variables --> 
    <script src="env.js"></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <script>
// ‚úÖ Configuraci√≥n Firebase desde env.js
const firebaseConfig = {
    apiKey: window._env_.FIREBASE_API_KEY,
    authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
    databaseURL: window._env_.FIREBASE_DATABASE_URL,
    projectId: window._env_.FIREBASE_PROJECT_ID,
    storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
    messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
    appId: window._env_.FIREBASE_APP_ID,
    measurementId: window._env_.FIREBASE_MEASUREMENT_ID
};

let auth, db;

// ‚úÖ Inicializaci√≥n Firebase
document.addEventListener("DOMContentLoaded", () => {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("‚úÖ Firebase inicializado correctamente.");
    }

    auth = firebase.auth();
    db = firebase.firestore();

       // ‚úÖ Check de autenticaci√≥n
  auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById("user-info").innerText = `Bienvenido, ${user.email}`;
        loadUserProfile(user.uid);
        loadReferrals(user.uid);
        listenForReferralUpdates(user.uid, user.email);
        listenToReferredUserPayments(user.uid);
        listenToReferredUserRegistrations(user.uid); // ‚úÖ Add this line
        } else {
        window.location.href = "login.html";
    }
      // ‚úÖ Show payment button if pending, or thank-you message if completed
function updatePaymentStatus(userData) {
  const warningEl = document.getElementById("payment-warning");
  const completeEl = document.getElementById("complete-payment");
  const paymentLinkEl = document.getElementById("payment-link");

  if (!warningEl || !completeEl || !paymentLinkEl) {
    console.warn("‚ö†Ô∏è Payment elements missing in DOM");
    return;
  }

  const status = (userData.paymentStatus || "").toLowerCase();

  if (status === "pending") {
    warningEl.style.display = "block";
    completeEl.style.display = "block";

    if (userData.checkoutLink) {
      paymentLinkEl.href = userData.checkoutLink;
    } else {
      // fallback links
      const wompiLinks = {
        prueba: "https://u.wompi.sv/539830hfH",
        basic3m: "https://u.wompi.sv/379910xeV",
        basic6m: "https://u.wompi.sv/380639rcA",
        basic12m: "https://u.wompi.sv/3806769qs",
        plus3m: "https://u.wompi.sv/380690Gbx",
        plus6m: "https://u.wompi.sv/380695_Np",
        plus12m: "https://u.wompi.sv/380702xQa",
        basic3mfull: "https://u.wompi.sv/478091RVm",
        basic6mfull: "https://u.wompi.sv/387432nHU",
        basic12mfull: "https://u.wompi.sv/387433i2m",
        plus3mfull: "https://u.wompi.sv/387439i_2",
        plus6mfull: "https://u.wompi.sv/387445Beb",
        plus12mfull: "https://u.wompi.sv/387447ZDj"
      };
      if (userData.planType && wompiLinks[userData.planType]) {
        paymentLinkEl.href = wompiLinks[userData.planType];
      }
    }
  } else if (status === "completed" || status === "confirmado") {
    warningEl.style.display = "none";
    completeEl.innerHTML = `<div style="color:green;font-weight:bold;">‚úÖ Pago confirmado. ¬°Gracias por unirte!</div>`;
    completeEl.style.display = "block";
  } else {
    warningEl.style.display = "none";
    completeEl.style.display = "none";
  }
}

});

});

        
/
// Update User Info in Dashboard
function updateUserInfo(userData) {
    document.getElementById("name").innerText = userData.name || "N/A";
    document.getElementById("phone").innerText = userData.phone || "N/A";
    document.getElementById("planType").innerText = userData.planType || "N/A";
    document.getElementById("current-schedule").innerText = userData.schedule ? `${userData.schedule.day} - ${userData.schedule.time}` : "No asignado";
    document.getElementById("user-department").innerText = userData.department || "Desconocido";
    document.getElementById("user-municipality").innerText = userData.municipality || "Desconocido";
    if (!userData.paymentDate || userData.paymentStatus === "Pending") {
    document.getElementById("paymentDate").innerText = "Pendiente de pago";
    document.getElementById("nextPaymentDate").innerText = "No asignado";
} else {
    document.getElementById("paymentDate").innerText = formatTimestamp(userData.paymentDate);
    document.getElementById("nextPaymentDate").innerText = formatTimestamp(userData.nextPaymentDate) || "No asignado";
}
// Hide countdown if payment is completed
const countdownContainer = document.querySelector(".countdown-container");
if (userData.paymentStatus === "Completed" || userData.paymentStatus === "Confirmado") {
    if (countdownContainer) countdownContainer.style.display = "none";
} else {
    if (countdownContainer) countdownContainer.style.display = "block";
}

    const subscriptionCard = document.getElementById("subscription-upgrade-card");
if (userData.paymentStatus === "Completed" || userData.paymentStatus === "Confirmado") {
    subscriptionCard.classList.remove("subscription-blurred");
} else {
    subscriptionCard.classList.add("subscription-blurred");
}
const lockedPopup = document.getElementById("subscription-locked-popup");
if (userData.paymentStatus === "Completed" || userData.paymentStatus === "Confirmado") {
    subscriptionCard.classList.remove("subscription-blurred");
    if (lockedPopup) lockedPopup.style.display = "none";
} else {
    subscriptionCard.classList.add("subscription-blurred");
    if (lockedPopup) lockedPopup.style.display = "block";
}

        document.getElementById("memberSince").innerText = formatTimestamp(userData.registrationDate) || "Desconocido";


    </script>

    
 
    <!-- Dashboard Content -->
  <!-- Dashboard Content -->
<section class="dashboard-section">

          
      <!-- BEGIN Estado de Pago section improved -->
<div class="estado-pago-card">
  <p><strong>Miembro Desde:</strong> <span id="memberSince">Cargando...</span></p>
  <p><strong>Fecha del √∫ltimo pago:</strong> <span id="paymentDate">Cargando...</span></p>
  <p><strong>Pr√≥ximo Pago:</strong> <span id="nextPaymentDate">Cargando...</span></p>
  <p><strong>Plan Elegido:</strong> <span id="PlanType">Cargando...</span></p>

  <div id="founderPhaseMessage">Cargando mensaje especial...</div>

  <!-- Payment warning -->
  <div id="payment-warning" style="display:none; color:#c0392b; font-weight:bold; margin-top:10px;">
    ‚ö†Ô∏è Tu pago est√° pendiente. Completa tu pago para activar tu plan.
  </div>

  <!-- Payment button container -->
  <div id="complete-payment" style="margin-top:10px; display:none;">
    <a id="payment-link" href="#" target="_blank"
       style="padding:10px 15px; background:#ff6600; color:white; border-radius:5px; text-decoration:none;">
       Completa tu pago ahora üîó
    </a>
  </div>
</div>
<!-- END Estado de Pago section improved -->


</section>
    </footer>


           </body>
</html>
