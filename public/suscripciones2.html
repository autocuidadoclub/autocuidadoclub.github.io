<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro en AutoCuidado Club</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Ensure env.js loads (fails silently if missing) -->
    <script>
        let firebaseConfig;
        let db, auth;

        function initializeFirebase() {
            if (window._env_ && window._env_.FIREBASE_API_KEY) {
                firebaseConfig = {
                    apiKey: window._env_.FIREBASE_API_KEY,
                    authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
                    projectId: window._env_.FIREBASE_PROJECT_ID,
                    storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
                    messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
                    appId: window._env_.FIREBASE_APP_ID
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("✅ Firebase initialized!");
                }

                db = firebase.firestore();
                auth = firebase.auth();
            } else {
                console.error("❌ Error: Firebase env.js not loaded.");
            }
        }

        // Load env.js dynamically and initialize Firebase
        function loadEnvAndInitFirebase() {
            const script = document.createElement("script");
            script.src = "env.js";
            script.onload = initializeFirebase;
            script.onerror = () => console.error("❌ Failed to load env.js.");
            document.head.appendChild(script);
        }

        document.addEventListener("DOMContentLoaded", loadEnvAndInitFirebase);
    </script>

    <script>
        function selectScheduleBox(cell, day) {
            document.querySelectorAll(".schedule-table td").forEach(td => td.classList.remove("selected"));
            cell.classList.add("selected");
            document.getElementById("selectedDay").value = day;
            document.getElementById("selectedTime").value = cell.innerText.trim();
        }

        function registerUser(event) {
            event.preventDefault();

            if (!db || !auth) {
                alert("❌ Firebase is not initialized.");
                return;
            }

            const formData = {
                name: document.getElementById("name").value.trim(),
                email: document.getElementById("email").value.trim(),
                phone: document.getElementById("phone").value.trim(),
                password: document.getElementById("password").value.trim(),
                planType: document.getElementById("planType").value,
                selectedDay: document.getElementById("selectedDay").value.trim(),
                selectedTime: document.getElementById("selectedTime").value.trim(),
                vehicles: []
            };

            // Get Vehicle Data
            document.querySelectorAll(".vehicle-entry").forEach(vehicle => {
                formData.vehicles.push({
                    brand: vehicle.querySelector(".vehicle-brand").value.trim(),
                    model: vehicle.querySelector(".vehicle-model").value.trim(),
                    year: vehicle.querySelector(".vehicle-year").value.trim(),
                    plate: vehicle.querySelector(".vehicle-plate").value.trim()
                });
            });

            // Firebase Authentication & Firestore Storage
            auth.createUserWithEmailAndPassword(formData.email, formData.password)
                .then(userCredential => {
                    formData.uid = userCredential.user.uid;
                    formData.registrationDate = firebase.firestore.Timestamp.now();
                    return db.collection("users").doc(formData.uid).set(formData);
                })
                .then(() => {
                    alert("✅ Registro exitoso!");
                    window.location.href = "profile.html";
                })
                .catch(error => {
                    console.error("❌ Firebase Error:", error);
                    alert("Error: " + error.message);
                });
        }
    </script>
</head>

<body>

    <h2>Registro en AutoCuidado Club</h2>
    <form id="registerForm" onsubmit="registerUser(event)">
        <label>Nombre:</label>
        <input type="text" id="name" required>

        <label>Email:</label>
        <input type="email" id="email" required>

        <label>Teléfono:</label>
        <input type="text" id="phone" required>

        <label>Contraseña:</label>
        <input type="password" id="password" required>

        <label>Selecciona tu Plan:</label>
        <select id="planType">
            <option value="basic3m">Basic - 1 Vehículo</option>
            <option value="plus3m">Plus - Hasta 3 Vehículos</option>
        </select>

        <div id="vehicles-section">
            <h3>Vehículos</h3>
            <div id="vehicle-container"></div>
        </div>

        <h2>Selecciona tu Horario</h2>
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>Horario</th>
                    <th>Lunes</th>
                    <th>Miércoles</th>
                    <th>Viernes</th>
                    <th>Sábado</th>
                    <th>Domingo</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Bloque 1</td>
                    <td onclick="selectScheduleBox(this, 'Lunes')">9:00 - 11:00</td>
                    <td onclick="selectScheduleBox(this, 'Miércoles')">10:00 - 12:00</td>
                    <td onclick="selectScheduleBox(this, 'Viernes')">13:00 - 15:00</td>
                    <td onclick="selectScheduleBox(this, 'Sábado')">8:00 - 10:00</td>
                    <td onclick="selectScheduleBox(this, 'Domingo')">9:00 - 11:00</td>
                </tr>
            </tbody>
        </table>

        <input type="hidden" id="selectedDay" required>
        <input type="hidden" id="selectedTime" required>

        <button type="submit">Registrarse</button>
    </form>

</body>
</html>
