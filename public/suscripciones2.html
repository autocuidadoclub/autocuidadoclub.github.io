<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro en AutoCuidado Club</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- ‚úÖ Force Load env.js to Prevent Caching Issues -->
    <script src="env.js?v=1.0"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("üîç Checking if env.js loaded:", window._env_);

        // ‚úÖ Ensure env.js is loaded before initializing Firebase
        if (typeof window._env_ === "undefined" || !window._env_.FIREBASE_API_KEY) {
            console.error("‚ùå Error: Firebase env.js not loaded.");
            alert("‚ùå Firebase is not initialized. Check env.js.");
            return;  // Stop execution if env.js is missing
        }

        // ‚úÖ Firebase Configuration from env.js
        const firebaseConfig = {
            apiKey: window._env_.FIREBASE_API_KEY,
            authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
            projectId: window._env_.FIREBASE_PROJECT_ID,
            storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
            messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
            appId: window._env_.FIREBASE_APP_ID,
            measurementId: window._env_.FIREBASE_MEASUREMENT_ID
        };

        // ‚úÖ Initialize Firebase only if not already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("‚úÖ Firebase initialized successfully!");
        } else {
            console.log("‚ÑπÔ∏è Firebase already initialized.");
        }

        // ‚úÖ Firebase References
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ‚úÖ Function to Select Schedule Box
        window.selectScheduleBox = function(cell, day) {
            document.querySelectorAll(".schedule-table td").forEach(td => td.classList.remove("selected"));
            cell.classList.add("selected");
            document.getElementById("selectedDay").value = day;
            document.getElementById("selectedTime").value = cell.innerText.trim();
            console.log(`‚úÖ Selected Schedule: ${day} - ${cell.innerText.trim()}`);
        };

        // ‚úÖ Function to Register User
        document.getElementById("registerForm").addEventListener("submit", function(event) {
            event.preventDefault();

            const name = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();
            const phone = document.getElementById("phone").value.trim();
            const password = document.getElementById("password").value.trim();
            const planType = document.getElementById("planType").value;
            const selectedDay = document.getElementById("selectedDay").value;
            const selectedTime = document.getElementById("selectedTime").value;

            if (!name || !email || !phone || !password || !selectedDay || !selectedTime) {
                alert("‚ùå Todos los campos son obligatorios.");
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const userId = userCredential.user.uid;
                    console.log("‚úÖ Usuario registrado:", userId);

                    return db.collection("users").doc(userId).set({
                        uid: userId,
                        name,
                        email,
                        phone,
                        planType,
                        schedule: { day: selectedDay, time: selectedTime },
                        registrationDate: firebase.firestore.Timestamp.now()
                    });
                })
                .then(() => {
                    alert("‚úÖ Registro exitoso. Redirigiendo...");
                    window.location.href = "profile.html";
                })
                .catch((error) => {
                    console.error("‚ùå Error en el registro:", error.message);
                    alert("‚ùå Error en el registro: " + error.message);
                });
        });
    });
    </script>

</head>

<body>

    <h2>Registro en AutoCuidado Club</h2>
    <form id="registerForm" onsubmit="registerUser(event)">
        <label>Nombre:</label>
        <input type="text" id="name" required>

        <label>Email:</label>
        <input type="email" id="email" required>

        <label>Tel√©fono:</label>
        <input type="text" id="phone" required>

        <label>Contrase√±a:</label>
        <input type="password" id="password" required>

        <label>Selecciona tu Plan:</label>
        <select id="planType">
            <option value="basic3m">Basic - 1 Veh√≠culo</option>
            <option value="plus3m">Plus - Hasta 3 Veh√≠culos</option>
        </select>

        <div id="vehicles-section">
            <h3>Veh√≠culos</h3>
            <div id="vehicle-container"></div>
        </div>

        <h2>Selecciona tu Horario</h2>
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>Horario</th>
                    <th>Lunes</th>
                    <th>Mi√©rcoles</th>
                    <th>Viernes</th>
                    <th>S√°bado</th>
                    <th>Domingo</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Bloque 1</td>
                    <td onclick="selectScheduleBox(this, 'Lunes')">9:00 - 11:00</td>
                    <td onclick="selectScheduleBox(this, 'Mi√©rcoles')">10:00 - 12:00</td>
                    <td onclick="selectScheduleBox(this, 'Viernes')">13:00 - 15:00</td>
                    <td onclick="selectScheduleBox(this, 'S√°bado')">8:00 - 10:00</td>
                    <td onclick="selectScheduleBox(this, 'Domingo')">9:00 - 11:00</td>
                </tr>
            </tbody>
        </table>

        <input type="hidden" id="selectedDay" required>
        <input type="hidden" id="selectedTime" required>

        <button type="submit">Registrarse</button>
    </form>

</body>
</html>
