<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - AutoCuidado Club</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Env variables -->
  <script src="env.js"></script>
</head>
<body>
  <section class="dashboard-section">
    <h2>Estado de Pago</h2>

    <div class="estado-pago-card">
      <p><strong>Miembro Desde:</strong> <span id="memberSince">Cargando...</span></p>
      <p><strong>Fecha del √∫ltimo pago:</strong> <span id="paymentDate">Cargando...</span></p>
      <p><strong>Pr√≥ximo Pago:</strong> <span id="nextPaymentDate">Cargando...</span></p>
      <p><strong>Plan Elegido:</strong> <span id="PlanType">Cargando...</span></p>

      <div id="founderPhaseMessage">Cargando mensaje especial...</div>

      <!-- Warning -->
      <div id="payment-warning" style="display:none; color:#c0392b; font-weight:bold; margin-top:10px;">
        ‚ö†Ô∏è Tu pago est√° pendiente. Completa tu pago para activar tu plan.
      </div>

      <!-- Payment Button -->
      <div id="complete-payment" style="margin-top:10px; display:none;">
        <a id="payment-link" href="#" target="_blank"
           style="padding:10px 15px; background:#ff6600; color:white; border-radius:5px; text-decoration:none;">
           Completa tu pago ahora üîó
        </a>
      </div>
    </div>
  </section>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: window._env_.FIREBASE_API_KEY,
      authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
      projectId: window._env_.FIREBASE_PROJECT_ID,
      storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
      messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
      appId: window._env_.FIREBASE_APP_ID
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log("‚úÖ Firebase inicializado.");
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // Helper
    function prettyDate(ts) {
      if (!ts) return "No asignado";
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleDateString("es-ES", { day: "numeric", month: "long", year: "numeric" });
      } catch {
        return "‚Äî";
      }
    }

    // Default Wompi links
    const wompiLinks = {
      prueba: "https://u.wompi.sv/539830hfH",
      basic3m: "https://u.wompi.sv/379910xeV",
      basic6m: "https://u.wompi.sv/380639rcA",
      basic12m: "https://u.wompi.sv/3806769qs",
      plus3m: "https://u.wompi.sv/380690Gbx",
      plus6m: "https://u.wompi.sv/380695_Np",
      plus12m: "https://u.wompi.sv/380702xQa",
      basic3mfull: "https://u.wompi.sv/478091RVm",
      basic6mfull: "https://u.wompi.sv/387432nHU",
      basic12mfull: "https://u.wompi.sv/387433i2m",
      plus3mfull: "https://u.wompi.sv/387439i_2",
      plus6mfull: "https://u.wompi.sv/387445Beb",
      plus12mfull: "https://u.wompi.sv/387447ZDj"
    };

    // ‚úÖ Update UI
function updateUI(userData) {
  const memberSinceEl = document.getElementById("memberSince");
  const paymentDateEl = document.getElementById("paymentDate");
  const nextPaymentEl = document.getElementById("nextPaymentDate");
  const planTypeEl = document.getElementById("PlanType");
  const founderPhaseEl = document.getElementById("founderPhaseMessage");
  const warningEl = document.getElementById("payment-warning");
  const completeEl = document.getElementById("complete-payment");
  const paymentLinkEl = document.getElementById("payment-link");

  const status = (userData.paymentStatus || "").toLowerCase();
  const today = new Date();
  const nextPaymentDate = userData.nextPaymentDate?.toDate
    ? userData.nextPaymentDate.toDate()
    : userData.nextPaymentDate
    ? new Date(userData.nextPaymentDate)
    : null;

  // Fill base info
  memberSinceEl.textContent = prettyDate(userData.registrationDate);
  paymentDateEl.textContent =
    status === "completed" && userData.paymentDate
      ? prettyDate(userData.paymentDate)
      : "Pendiente de pago";
  nextPaymentEl.textContent = prettyDate(userData.nextPaymentDate);
  planTypeEl.textContent = userData.planType || "No asignado";
  founderPhaseEl.textContent =
    "‚ö†Ô∏è Fase Fundador Cerrada ‚Äì Ahora puedes registrarte, pero con nuevas tarifas.";

  // Hide all by default
  warningEl.style.display = "none";
  completeEl.style.display = "none";

  // --- Payment Logic ---
 // --- Payment Logic ---
const isExpired = nextPaymentDate && nextPaymentDate < today;

if (status === "pending" || isExpired) {
  warningEl.style.display = "block";
  completeEl.style.display = "block";

  const rawLink = (userData.checkoutLink || wompiLinks[userData.planType] || "#").trim();
  console.log("Final payment link:", JSON.stringify(rawLink));

  // Instead of setting href only, attach a safe click handler
  paymentLinkEl.removeAttribute("href"); // avoid browser rewriting
  paymentLinkEl.onclick = (e) => {
    e.preventDefault();
    window.open(rawLink, "_blank", "noopener,noreferrer");
  };
  paymentLinkEl.textContent = "Completa tu pago ahora üîó";

} else if (status === "completed" || status === "confirmado") {
  if (!isExpired) {
    completeEl.innerHTML =
      `<div style="color:green;font-weight:bold;">‚úÖ Pago confirmado. ¬°Gracias por unirte!</div>`;
    completeEl.style.display = "block";
  }
}

} // ‚úÖ close function here, nothing more


    // ‚úÖ Auth listener
    auth.onAuthStateChanged(user => {
      if (!user) return;
      db.collection("users").doc(user.uid).get()
        .then(doc => {
          if (doc.exists) {
            updateUI(doc.data());
          }
        })
        .catch(err => console.error("‚ùå Error obteniendo userData:", err));
    });
  });
  </script>
</body>
</html>
