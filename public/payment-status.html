<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - AutoCuidado Club</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Env variables -->
  <script src="env.js"></script>
</head>
<body>
  <section class="dashboard-section">
    <h2>Estado de Pago</h2>

    <div class="estado-pago-card">
      <p><strong>Miembro Desde:</strong> <span id="memberSince">Cargando...</span></p>
      <p><strong>Fecha del √∫ltimo pago:</strong> <span id="paymentDate">Cargando...</span></p>
      <p><strong>Pr√≥ximo Pago:</strong> <span id="nextPaymentDate">Cargando...</span></p>
      <p><strong>Plan Elegido:</strong> <span id="PlanType">Cargando...</span></p>

      <div id="founderPhaseMessage">Cargando mensaje especial...</div>

      <!-- Warning -->
      <div id="payment-warning" style="display:none; color:#c0392b; font-weight:bold; margin-top:10px;">
        ‚ö†Ô∏è Tu pago est√° pendiente. Completa tu pago para activar tu plan.
      </div>

      <!-- Payment Button -->
      <div id="complete-payment" style="margin-top:10px; display:none;">
        <a id="payment-link" href="#" target="_blank"
           style="padding:10px 15px; background:#ff6600; color:white; border-radius:5px; text-decoration:none;">
           Completa tu pago ahora üîó
        </a>
      </div>
    </div>
  </section>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Firebase config
    const firebaseConfig = {
      apiKey: window._env_.FIREBASE_API_KEY,
      authDomain: window._env_.FIREBASE_AUTH_DOMAIN,
      databaseURL: window._env_.FIREBASE_DATABASE_URL,
      projectId: window._env_.FIREBASE_PROJECT_ID,
      storageBucket: window._env_.FIREBASE_STORAGE_BUCKET,
      messagingSenderId: window._env_.FIREBASE_MESSAGING_SENDER_ID,
      appId: window._env_.FIREBASE_APP_ID,
      measurementId: window._env_.FIREBASE_MEASUREMENT_ID
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log("‚úÖ Firebase inicializado.");
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // Helper
    function prettyDate(ts) {
      if (!ts) return "No asignado";
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleDateString("es-ES", { day: "numeric", month: "long", year: "numeric" });
      } catch {
        return "‚Äî";
      }
    }

    // Default Wompi links
    const wompiLinks = {
      prueba: "https://u.wompi.sv/539830hfH",
      basic3m: "https://u.wompi.sv/379910xeV",
      basic6m: "https://u.wompi.sv/380639rcA",
      basic12m: "https://u.wompi.sv/3806769qs",
      plus3m: "https://u.wompi.sv/380690Gbx",
      plus6m: "https://u.wompi.sv/380695_Np",
      plus12m: "https://u.wompi.sv/380702xQa",
      basic3mfull: "https://u.wompi.sv/478091RVm",
      basic6mfull: "https://u.wompi.sv/387432nHU",
      basic12mfull: "https://u.wompi.sv/387433i2m",
      plus3mfull: "https://u.wompi.sv/387439i_2",
      plus6mfull: "https://u.wompi.sv/387445Beb",
      plus12mfull: "https://u.wompi.sv/387447ZDj"
    };

    // UI Update
    function updateUI(userData) {
      document.getElementById("memberSince").textContent = prettyDate(userData.registrationDate);
      document.getElementById("paymentDate").textContent =
        userData.paymentStatus?.toLowerCase() === "completed" && userData.paymentDate
          ? prettyDate(userData.paymentDate)
          : "Pendiente de pago";
      document.getElementById("nextPaymentDate").textContent = prettyDate(userData.nextPaymentDate);
      document.getElementById("PlanType").textContent = userData.planType || "No asignado";
      document.getElementById("founderPhaseMessage").textContent =
        "‚ö†Ô∏è Fase Fundador Cerrada ‚Äì Ahora puedes registrarte, pero con nuevas tarifas.";

      const warningEl = document.getElementById("payment-warning");
      const completeEl = document.getElementById("complete-payment");
      const linkEl = document.getElementById("payment-link");

      warningEl.style.display = "none";
      completeEl.style.display = "none";

      const status = (userData.paymentStatus || "").toLowerCase();

      if (status === "pending") {
        warningEl.style.display = "block";
        completeEl.style.display = "block";
        const link = userData.checkoutLink || wompiLinks[userData.planType] || "#";
        linkEl.href = link;
        linkEl.textContent = "Completa tu pago ahora üîó";
      } else if (status === "completed" || status === "confirmado") {
        completeEl.innerHTML = `<div style="color:green;font-weight:bold;">‚úÖ Pago confirmado. ¬°Gracias por unirte!</div>`;
        completeEl.style.display = "block";
      }
    }

    // Auth listener
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      db.collection("users").doc(user.uid).onSnapshot(doc => {
        if (doc.exists) {
          updateUI(doc.data());
        }
      });
    });
  });
  </script>
</body>
</html>
